
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TURNAMENT</title>

    <!-- Icons and Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* --- PREMIUM GAMING UI SYSTEM v4.0 --- */
        :root {
            /* Core Palette */
            --bg-body: #09090b;
            --bg-surface: #121217;
            --bg-surface-lighter: #1c1c24;
            
            /* Brand Colors */
            --primary: #6C5DD3;
            --primary-dark: #5345a8;
            --primary-glow: rgba(108, 93, 211, 0.5);
            
            --secondary: #00D2FF;
            --secondary-dark: #00a0c4;
            --secondary-glow: rgba(0, 210, 255, 0.4);
            
            --accent-gradient: linear-gradient(135deg, #6C5DD3 0%, #00D2FF 100%);
            
            /* Functional Colors */
            --success: #00E096;
            --danger: #FF3D71;
            --warning: #FFAA00;
            --info: #2f80ed;

            /* Typography */
            --text-main: #FFFFFF;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;

            /* UI Properties */
            --glass-bg: rgba(18, 18, 23, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            --border-subtle: rgba(255, 255, 255, 0.06);
            --radius-xl: 24px;
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            
            /* Elevation */
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.4);
            --shadow-glow: 0 0 20px rgba(108, 93, 211, 0.25);
        }



        /* --- Global Reset & Base --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none !important;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            padding-top: 85px; /* Account for fixed header */
            padding-bottom: 100px; /* Account for floating nav */
            min-height: 100vh;
            /* Subtle background noise/gradient */
            background-image: 
                radial-gradient(circle at 15% 15%, rgba(108, 93, 211, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 85% 85%, rgba(0, 210, 255, 0.06) 0%, transparent 40%);
            background-attachment: fixed;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 0.5rem;
        }

        p {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        a {
            text-decoration: none;
            color: inherit;
            transition: color 0.2s ease;
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-body);
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* --- Header Styling --- */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 72px;
            background: rgba(9, 9, 11, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1030;
            transition: all 0.3s ease;
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
        }

        .header-logo {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 15px rgba(108, 93, 211, 0.2);
        }

        .header-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.15rem;
            line-height: 1.1;
            margin-left: 12px;
            font-weight: 700;
            display: flex;
            flex-direction: column;
        }

        .header-title span {
            font-family: 'Poppins', sans-serif;
            font-size: 0.75rem;
            color: var(--secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header-back-button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            width: 38px;
            height: 38px;
            border-radius: 10px;
            color: var(--text-main);
            display: none; /* Controlled by JS */
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            transition: all 0.2s;
        }
        .header-back-button:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }

        .header-game-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.35rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            background: linear-gradient(to right, #fff, #b4b4b4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: none;
        }

        .wallet-chip {
            background: rgba(108, 93, 211, 0.1);
            border: 1px solid rgba(108, 93, 211, 0.3);
            color: var(--text-main);
            padding: 6px 14px;
            border-radius: 30px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .wallet-chip i { color: var(--secondary); }
        .wallet-chip:hover {
            background: rgba(108, 93, 211, 0.2);
            box-shadow: 0 0 12px var(--primary-glow);
            border-color: var(--primary);
        }

        .notification-icon {
            color: var(--text-main);
            font-size: 1.25rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            position: relative;
            transition: all 0.2s;
        }
        .notification-icon:active { transform: scale(0.95); }

        .notification-badge {
            background: var(--danger);
            top: -2px;
            right: -2px;
            border: 2px solid var(--bg-body);
            box-shadow: 0 0 8px rgba(255, 61, 113, 0.6);
        }

        /* --- Bottom Navigation --- */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            height: 70px;
            background: rgba(22, 22, 28, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 1020;
            padding: 0 8px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            background: transparent;
            border: none;
            width: 60px;
            height: 100%;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-item i {
            font-size: 1.35rem;
            margin-bottom: 4px;
            transition: 0.3s;
        }

        .nav-item span {
            font-size: 0.7rem;
            font-weight: 500;
            opacity: 0;
            transform: translateY(10px);
            transition: 0.3s;
            position: absolute;
            bottom: 8px;
        }

        .nav-item.active {
            color: var(--text-main);
        }

        .nav-item.active i {
            color: var(--primary);
            text-shadow: 0 0 15px var(--primary-glow);
            transform: translateY(-8px);
        }

        .nav-item.active span {
            opacity: 1;
            transform: translateY(0);
            color: var(--text-main);
        }

        /* --- Sections Layout --- */
        .main-content {
            padding: 0 16px;
            max-width: 800px;
            margin: 0 auto;
        }

        .section {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }

        .section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 1.25rem;
            margin: 24px 0 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-main);
            position: relative;
            padding-left: 12px;
        }
        
        .section-title::before {
            content: '';
            position: absolute;
            left: 0;
            height: 20px;
            width: 4px;
            background: var(--accent-gradient);
            border-radius: 4px;
        }

        /* --- Cards --- */
        .custom-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        /* --- Buttons --- */
        .btn {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            letter-spacing: 0.5px;
            padding: 10px 24px;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
        }

        .btn:active { transform: scale(0.97); }

        .btn-custom-primary {
            background: var(--primary);
            border: none;
            color: #fff;
            box-shadow: 0 4px 15px var(--primary-glow);
        }
        .btn-custom-primary:hover {
            background: var(--primary-dark);
            color: #fff;
            box-shadow: 0 6px 20px var(--primary-glow);
        }

        .btn-custom-accent {
            background: var(--accent-gradient);
            border: none;
            color: #fff;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.25);
        }
        .btn-custom-accent:hover {
            color: #fff;
            filter: brightness(1.1);
        }

        .btn-custom-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            color: var(--text-main);
        }
        .btn-custom-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-color: rgba(255, 255, 255, 0.2);
        }

        .btn-custom-link {
            color: var(--secondary);
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0;
            background: none;
            border: none;
        }
        .btn-custom-link:hover { color: #fff; text-decoration: underline; }

        /* --- Forms & Inputs --- */
        .form-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            background: #000000;
            border: 1px solid var(--border-subtle);
            color: var(--text-main);
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 0.95rem;
            transition: 0.3s;
        }

        .form-control:focus {
            background: #000000;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 93, 211, 0.15);
            color: #fff;
        }
        
        .form-control::placeholder { color: #4b5563; }

        /* --- Swiper --- */
        .swiper-container {
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            margin-bottom: 24px;
        }
        
        .swiper-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-lg);
        }

       /* --- PREMIUM SLIDER STYLE --- */
.swiper-pagination {
    display: none !important; /* ‡¶°‡¶ü ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ */
}

.swiper-container {
    padding-bottom: 10px;
    overflow: hidden;
}

.swiper-slide {
    transition: transform 0.5s;
}

.swiper-slide img {
    border-radius: 15px; /* ‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶°‡ßá‡¶° ‡¶ï‡¶∞‡ßç‡¶®‡¶æ‡¶∞ */
    box-shadow: 0 8px 20px rgba(0,0,0,0.6); /* ‡¶™‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡¶Ø‡¶º‡¶æ‡¶Æ ‡¶°‡¶æ‡¶∞‡ßç‡¶ï ‡¶∂‡ßç‡¶Ø‡¶æ‡¶°‡ßã */
}

        /* --- PREMIUM HORIZONTAL GAME SELECTOR --- */
.games-scroll-container {
    display: flex;
    overflow-x: auto;
    gap: 15px;
    padding: 10px 0 25px 0;
    scrollbar-width: none; /* Firefox ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø scrollbar ‡¶π‡¶æ‡¶á‡¶° */
    -ms-overflow-style: none; /* IE ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
}

.games-scroll-container::-webkit-scrollbar {
    display: none; /* Chrome/Safari ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø scrollbar ‡¶π‡¶æ‡¶á‡¶° */
}

.game-item {
    flex: 0 0 auto;
    width: 90px; /* ‡¶Ü‡¶á‡¶ï‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶á‡¶ú ‡¶õ‡ßã‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá */
    text-align: center;
    transition: transform 0.3s ease;
    cursor: pointer;
}

.game-icon-wrapper {
    width: 80px;
    height: 80px;
    background: linear-gradient(145deg, #1c1c24, #121217);
    border-radius: 22px; /* ‡¶™‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡ßü‡¶æ‡¶Æ ‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶°‡ßá‡¶° ‡¶≤‡ßÅ‡¶ï */
    border: 1px solid rgba(255, 255, 255, 0.08);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 8px auto;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 20px rgba(0,0,0,0.4);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.game-icon-wrapper img {
    width: 85%;
    height: 85%;
    object-fit: contain;
    filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5));
}

.game-item:hover .game-icon-wrapper {
    transform: translateY(-5px);
    border-color: var(--primary);
    box-shadow: 0 0 20px var(--primary-glow);
}

.game-item span {
    font-size: 0.75rem;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.game-item:hover span {
    color: var(--primary);
}

        /* --- NEW PREMIUM ANDROID STYLE TOURNAMENT CARD --- */
.tournament-card {
    background: #1a1a24;
    border: 1px solid rgba(108, 93, 211, 0.2);
    border-radius: 24px;
    padding: 20px;
    margin-bottom: 20px;
    position: relative;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.t-header-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 18px;
}

.t-header-left {
    display: flex;
    gap: 15px;
    align-items: center;
}

.t-game-img-wrapper {
    position: relative;
    width: 65px;
    height: 65px;
    background: #252533;
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.t-game-img-wrapper i {
    font-size: 2rem;
    color: var(--primary);
}

.t-status-dot {
    position: absolute;
    top: -2px;
    right: -2px;
    width: 14px;
    height: 14px;
    background: #00E096;
    border: 2px solid #1a1a24;
    border-radius: 50%;
    box-shadow: 0 0 10px #00E096;
}

.t-title-area h3 {
    font-size: 1.15rem;
    margin: 0;
    color: #fff;
    font-weight: 700;
}

.t-meta-info {
    font-size: 0.75rem;
    color: #94A3B8;
    margin-top: 4px;
}

.status-live-badge {
    background: rgba(255, 61, 113, 0.1);
    color: #FF3D71;
    border: 1px solid rgba(255, 61, 113, 0.3);
    padding: 4px 12px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 800;
    text-transform: uppercase;
}

.t-schedule-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    margin-top: 4px;
}

.t-schedule-info span {
    font-size: 0.75rem;
    color: #94A3B8;
    display: flex;
    align-items: center;
    gap: 5px;
}

.t-timer-text {
    color: #FFAA00 !important; /* ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∞‡¶ô ‡¶∏‡ßã‡¶®‡¶æ‡¶≤‡ßÄ/‡¶π‡¶≤‡ßÅ‡¶¶ */
    font-weight: 600;
}

.t-meta-row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
    padding-left: 5px;
}

.t-meta-row span {
    font-size: 0.75rem;
    color: #cbd5e1;
    background: rgba(255,255,255,0.05);
    padding: 2px 8px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 5px;
}

/* Stats Boxes */
.t-stats-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}

.t-stat-box {
    background: #21212e;
    padding: 12px 8px;
    border-radius: 16px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.03);
}

.t-stat-label {
    display: block;
    font-size: 0.6rem;
    color: #64748B;
    text-transform: uppercase;
    font-weight: 700;
    margin-bottom: 4px;
}

.t-stat-value {
    font-family: 'Rajdhani', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    color: #00D2FF;
}

/* Progress Section */
.t-progress-label-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: #94A3B8;
    margin-bottom: 8px;
}

.t-progress-bar-bg {
    height: 8px;
    background: #0f0f15;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 20px;
}

.t-progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #6C5DD3, #00D2FF);
    border-radius: 10px;
    transition: width 0.5s;
}

/* Buttons Area */
.t-btn-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.btn-details-outline {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #fff;
    border-radius: 14px;
    height: 48px;
    font-weight: 600;
    font-size: 0.85rem;
}

.btn-join-gradient {
    background: linear-gradient(135deg, #6C5DD3 0%, #00D2FF 100%);
    color: #fff;
    border: none;
    border-radius: 14px;
    height: 48px;
    font-weight: 700;
    font-size: 0.85rem;
    box-shadow: 0 4px 15px rgba(108, 93, 211, 0.3);
}

/* Room ID Area */
.t-room-info-bar {
    background: rgba(0, 224, 150, 0.05);
    border: 1.5px dashed rgba(0, 224, 150, 0.3);
    border-radius: 14px;
    padding: 12px;
    margin-top: 15px;
    text-align: center;
    color: #00E096;
    font-weight: 700;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
}

        /* --- Tabs --- */
        .tournament-tabs {
            background: #111;
            padding: 6px;
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .tab-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            background: transparent;
            border: none;
            transition: all 0.3s ease;
        }

        .tab-item.active {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 4px 12px rgba(108, 93, 211, 0.3);
            font-weight: 600;
        }

        /* --- Wallet --- */
        .wallet-card {
            background: radial-gradient(circle at top right, #2a2a35 0%, #16161e 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            padding: 24px !important;
        }
        
        .wallet-card::before {
            content: '';
            position: absolute;
            top: -50px; left: -50px;
            width: 150px; height: 150px;
            background: var(--primary);
            filter: blur(80px);
            opacity: 0.3;
        }

        .balance-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            margin-bottom: 16px;
            padding-bottom: 16px;
        }
        
        .balance-item:last-of-type { border-bottom: none; margin-bottom: 20px; }

        .balance-item-value {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: #fff;
            letter-spacing: 0.5px;
        }

        .balance-item-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .btn-withdraw {
            background: rgba(0, 224, 150, 0.15);
            color: var(--success);
            font-weight: 700;
            border: 1px solid rgba(0, 224, 150, 0.3);
            transition: 0.3s;
        }
        .btn-withdraw:hover {
            background: var(--success);
            color: #000;
            box-shadow: 0 0 15px rgba(0, 224, 150, 0.4);
        }

        /* --- Profile --- */
        .profile-header-card {
            background: linear-gradient(180deg, #1c1c24 0%, #121217 100%);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 30px 20px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border: 3px solid var(--bg-body);
            outline: 2px solid var(--primary);
            border-radius: 50%;
            padding: 2px;
            box-shadow: 0 0 25px var(--primary-glow);
            object-fit: cover;
        }

        .profile-name { font-size: 1.5rem; margin-top: 15px; font-weight: 700; }
        
        .stat-item { padding: 0 10px; }
        .stat-item strong {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.5rem;
            color: var(--secondary);
            display: block;
        }

        .list-group-item {
            background: transparent;
            color: var(--text-main);
            border: none;
            border-bottom: 1px solid var(--border-subtle);
            padding: 16px 20px;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.2s;
        }

        .list-group-item:last-child { border-bottom: none; }
        .list-group-item:hover { background: rgba(255,255,255,0.03); padding-left: 25px; color: var(--primary); }
        .list-group-item i:first-child { color: var(--text-muted); width: 30px; font-size: 1.1rem; transition: 0.2s; }
        .list-group-item:hover i:first-child { color: var(--primary); }

        /* --- Modals --- */
        .modal-content {
            background: #18181b;
            border: 1px solid var(--border-subtle);
            color: var(--text-main);
            border-radius: var(--radius-lg);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        }

        .modal-header { border-bottom: 1px solid var(--border-subtle); padding: 20px 24px; }
        .modal-body { padding: 24px; color: var(--text-secondary) !important; }
        .modal-footer { border-top: 1px solid var(--border-subtle); padding: 16px 24px; }
        .modal-title { font-family: 'Rajdhani', sans-serif; font-weight: 700; color: #fff; }
        
        /* Fix modal text visibility overrides */
        .modal-content p, .modal-content span, .modal-content div, .modal-content label { color: #e2e8f0; }
        .modal-content .text-muted { color: #94a3b8 !important; }
        .modal-content .text-white { color: #ffffff !important; }

        /* --- Loading & Misc --- */
        #globalLoaderEl {
            background: rgba(5, 5, 5, 0.9);
            backdrop-filter: blur(10px);
        }
        
        .spinner-border {
            border-color: var(--primary) transparent var(--secondary) transparent;
        }

        .placeholder {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        /* Security Warning */
        #securityWarning {
            background: rgba(255, 61, 113, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--danger);
            color: #fff;
            padding: 10px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: fixed;
            top: 72px; width: 100%; z-index: 999;
        }
        #securityWarning button {
            background: var(--danger); color: white; border: none; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem;
        }

        /* Login Card */
        #login-section .card {
            background: rgba(18, 18, 23, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-subtle);
        }
        
        /* Utils */
        .text-info { color: var(--info) !important; }
        .text-success { color: var(--success) !important; }
        .text-warning { color: var(--warning) !important; }
        .text-danger { color: var(--danger) !important; }
        
       //* --- 3D PREMIUM LEADERBOARD (FIXED) --- */

.leaderboard-container {
    padding-bottom: 50px;
    perspective: 1000px; /* 3D ‡¶≠‡¶æ‡¶¨ ‡¶Ü‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
}

/* Header */
.lb-header {
    display: flex;
    justify-content: space-between;
    padding: 15px 20px;
    background: rgba(255,255,255,0.03);
    border-radius: 12px;
    margin-bottom: 15px;
    color: #888;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.8rem;
}

/* Card Style */
.lb-card {
    display: flex;
    align-items: center;
    background: linear-gradient(145deg, #16161c, #0e0e12);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    padding: 10px 15px;
    margin-bottom: 12px;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.3s;
    /* Animation */
    opacity: 0;
    animation: slideIn 0.5s forwards;
}

.lb-card:hover {
    transform: translateY(-3px) scale(1.01);
    background: rgba(255,255,255,0.05);
}

/* --- RANK STYLES (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶ï‡ßã‡¶° ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶°) --- */
.lb-rank {
    font-family: 'Rajdhani', sans-serif;
    font-size: 1.2rem;
    font-weight: 700;
    width: 50px;
    text-align: center;
    color: #666;
}

/* Rank 1 - GOLD */
.rank-1 .lb-rank {
    font-size: 1.8rem;
    background: linear-gradient(135deg, #FFD700 0%, #FFF 50%, #FFD700 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
    animation: gold-glow 2.5s infinite alternate;
}

/* Rank 2 - SILVER */
.rank-2 .lb-rank {
    font-size: 1.6rem;
    background: linear-gradient(135deg, #E0E0E0 0%, #FFF 50%, #B0B0B0 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow: 0 5px 15px rgba(192, 192, 192, 0.2);
}

/* Rank 3 - BRONZE */
.rank-3 .lb-rank {
    font-size: 1.5rem;
    background: linear-gradient(135deg, #CD7F32 0%, #E0A04D 50%, #A05A1A 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow: 0 5px 15px rgba(205, 127, 50, 0.2);
}

/* Avatar */
.lb-img {
    width: 42px; height: 42px;
    border-radius: 50%;
    border: 2px solid #333;
    object-fit: cover;
    margin-right: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}
.rank-1 .lb-img { border-color: #FFD700; }
.rank-2 .lb-img { border-color: #C0C0C0; }
.rank-3 .lb-img { border-color: #CD7F32; }

/* Info */
.lb-info { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.lb-name { font-size: 0.95rem; font-weight: 600; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.lb-uid { font-size: 0.7rem; color: #888; font-family: monospace; }

/* Earnings */
.lb-earn {
    text-align: right;
    min-width: 80px;
}
.lb-amount {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 800;
    font-size: 1.1rem;
    color: #00E096;
    text-shadow: 0 0 10px rgba(0, 224, 150, 0.2);
}
@keyframes slideIn { to { opacity: 5; } }

/* --- PREMIUM SQUAD MODAL STYLES --- */
.modal-glass {
    background: #0f0f13; /* Deep Dark Background */
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 0 40px rgba(0, 0, 0, 0.8);
}

.modal-header-premium {
    background: linear-gradient(90deg, rgba(108, 93, 211, 0.1) 0%, transparent 100%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    padding: 20px;
}

/* Teammate Finder Banner */
.finder-banner {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 1px solid rgba(108, 93, 211, 0.3);
    border-radius: 12px;
    padding: 15px;
    position: relative;
    overflow: hidden;
    cursor: pointer;
    transition: 0.3s;
}
.finder-banner::after {
    content: '';
    position: absolute;
    top: 0; right: 0;
    width: 60px; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(108, 93, 211, 0.1));
}
.finder-banner:active { transform: scale(0.98); }

/* Squad Form Area */
.squad-creation-zone {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    padding: 20px;
    margin-top: 20px;
}

/* Premium Inputs */
.input-group-premium {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    display: flex;
    align-items: center;
    transition: 0.3s;
    overflow: hidden;
}
.input-group-premium:focus-within {
    border-color: var(--primary);
    box-shadow: 0 0 15px rgba(108, 93, 211, 0.2);
    background: rgba(0, 0, 0, 0.5);
}

.input-icon-box {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.05);
    color: #888;
}

.form-control-ghost {
    background: transparent;
    border: none;
    color: #fff;
    padding: 10px;
    font-size: 0.9rem;
    width: 100%;
}
.form-control-ghost:focus { background: transparent; color: #fff; box-shadow: none; }
.form-control-ghost::placeholder { color: #555; }

/* Player Slot Design */
.player-slot {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
    opacity: 0.6;
    transition: 0.3s;
}
.player-slot.active { opacity: 1; }
.player-slot.leader .input-group-premium { border-color: #FFAA00; background: rgba(255, 170, 0, 0.05); }

/* Save Button */
.btn-save-squad {
    background: linear-gradient(90deg, #6C5DD3 0%, #00D2FF 100%);
    border: none;
    color: white;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    height: 50px;
    border-radius: 12px;
    width: 100%;
    margin-top: 15px;
    box-shadow: 0 4px 20px rgba(108, 93, 211, 0.4);
    transition: 0.3s;
}
.btn-save-squad:active { transform: scale(0.97); }

/* Scrollable Saved List */
.saved-squads-container {
    max-height: 150px;
    overflow-y: auto;
    margin-bottom: 20px;
    padding-right: 5px;
}
 
/* --- NEW PREMIUM PROFILE 3D DESIGN --- */
.premium-3d-box {
    background: linear-gradient(145deg, #13131a, #0e0e12); /* ‡¶°‡¶ø‡¶™ 3D ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° */
    border-radius: 20px;
    box-shadow: 
        8px 8px 16px rgba(0,0,0,0.6), 
        -2px -2px 5px rgba(255,255,255,0.05); /* 3D Shadow Effect */
    border: 1px solid rgba(255, 255, 255, 0.05);
    overflow: hidden;
    margin-bottom: 25px;
    position: relative;
}

/* Card 1 Styles */
.profile-top-content { padding: 25px 20px; text-align: center; }
.profile-avatar-3d {
    width: 90px; height: 90px;
    border-radius: 50%;
    border: 3px solid #1a1a2e;
    box-shadow: 0 0 15px rgba(108, 93, 211, 0.5); /* Primary Glow */
    object-fit: cover;
    margin-bottom: 10px;
}
.edit-badge-btn {
    position: absolute; bottom: 0; right: 0;
    background: var(--primary);
    width: 28px; height: 28px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    border: 2px solid #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
}

/* Stats Row */
.stats-3d-container {
    display: flex;
    justify-content: space-between;
    background: rgba(0,0,0,0.3); /* Darker inset */
    border-top: 1px solid rgba(255,255,255,0.05);
    border-bottom: 1px solid rgba(255,255,255,0.05);
    padding: 15px 0;
    margin: 15px 0;
}
.stat-3d-item { flex: 1; text-align: center; border-right: 1px solid rgba(255,255,255,0.05); }
.stat-3d-item:last-child { border-right: none; }
.stat-3d-val { font-family: 'Rajdhani', sans-serif; font-size: 1.4rem; font-weight: 700; color: #fff; }
.stat-3d-lbl { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }

/* Find Player Button inside Card 1 */
.find-player-area { padding: 0 20px 20px 20px; }
.btn-3d-gradient {
    width: 100%;
    background: linear-gradient(90deg, #6C5DD3 0%, #00D2FF 100%);
    border: none;
    padding: 14px;
    border-radius: 12px;
    color: white;
    font-weight: 700;
    text-transform: uppercase;
    font-family: 'Rajdhani', sans-serif;
    letter-spacing: 1px;
    box-shadow: 0 5px 15px rgba(108, 93, 211, 0.3);
    display: flex; align-items: center; justify-content: center; gap: 10px;
}
.btn-3d-gradient:active { transform: scale(0.98); box-shadow: 0 2px 5px rgba(108, 93, 211, 0.3); }

/* Card 2 Styles (Menu List) */
.menu-list-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 18px 20px;
    background: transparent;
    border: none;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    width: 100%; text-align: left;
    color: #e0e0e0;
    transition: 0.2s;
    text-decoration: none;
}
.menu-list-item:last-child { border-bottom: none; }
.menu-list-item:active { background: rgba(255,255,255,0.03); }

.menu-icon { width: 30px; font-size: 1.1rem; color: #666; transition: 0.3s; }
.menu-list-item:hover .menu-icon { color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); }
.arrow-icon { color: #333; font-size: 0.8rem; }

   </style>
</head>

<body>

<!-- ‡¶™‡ßç‡¶∞‡¶´‡ßá‡¶∂‡¶®‡¶æ‡¶≤ ‡¶∏‡ßç‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® -->
    <div id="splashScreenEl" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #09090b; z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <div class="mb-4">
           
        </div>
        <h2 class="text-white fw-bold" style="font-family: 'Rajdhani', sans-serif; letter-spacing: 2px;">GAMING <span class="text-primary">ZONE</span></h2>
        <div class="spinner-border text-primary mt-4" style="width: 1.5rem; height: 1.5rem; border-width: 0.2em;"></div>
    </div>

    <style>
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>

    <!-- Firebase Security Rules Warning -->
    <div id="securityWarning" style="display: none;">
        <i class="bi bi-shield-exclamation text-danger"></i> <span>Security Alert: Database rules are insecure.</span>
        <a href="https://firebase.google.com/docs/database/security" target="_blank" rel="noopener noreferrer" style="color: var(--danger); font-weight: 700;">Fix Now</a>
        <button onclick="this.parentElement.style.display='none'">Dismiss</button>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <button class="header-back-button" id="headerBackBtnEl"><i class="bi bi-chevron-left"></i></button>
            <img src="https://via.placeholder.com/44/6C5DD3/FFFFFF?text=G" alt="Logo" class="header-logo" id="appLogoEl">
            <div class="header-title" id="headerTitleContainerEl">
                Welcome <span id="headerUserGreetingEl">Guest</span>
            </div>
            <div class="header-game-title" id="headerGameTitleEl">Game Title</div>
        </div>
        <div class="header-right gap-3">
            <button class="wallet-chip" id="headerWalletChipEl" style="display: none;">
                <i class="bi bi-wallet2"></i> ‡ß≥<span id="headerChipBalanceEl">0</span>
            </button>
            <button class="notification-icon" id="notificationBtnEl">
                <i class="bi bi-bell"></i> 
                <span class="notification-badge rounded-circle position-absolute" style="width: 10px; height: 10px; display: none;"></span>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-content">
        <div id="globalLoaderEl" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; justify-content: center; align-items: center; display: none;">
            <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>

        <!-- Login Section -->
        <section id="login-section" class="section">
            <div class="container d-flex align-items-center justify-content-center" style="min-height: 80vh;">
                <div class="card shadow-lg custom-card w-100" style="max-width: 400px; padding: 10px;">
                    <div class="card-body p-4">
                        <!-- Login Form -->
                        <form id="emailLoginForm">
                            <div class="text-center mb-5">
                                <h2 class="card-title text-white">WELCOME BACK</h2>
                                <p class="small text-muted">Enter your credentials to continue</p>
                            </div>
                            <div class="mb-4">
                                <label for="loginEmailInputEl" class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="loginEmailInputEl" placeholder="player@example.com" required>
                            </div>
                            <div class="mb-4">
                                <label for="loginPasswordInputEl" class="form-label">Password</label>
                                <input type="password" class="form-control" id="loginPasswordInputEl" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                            </div>
                            <div id="loginStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-3 mb-4">
                                <button type="button" class="btn btn-custom-primary" id="loginEmailBtnEl">LOG IN</button>
                                <button type="button" class="btn btn-custom-secondary" id="showSignupToggleBtnEl">CREATE ACCOUNT</button>
                            </div>
                            <a href="#" id="forgotPasswordLinkEl" class="text-center small d-block text-decoration-none text-muted hover-white">Forgot Password?</a>
                        </form>

                        <!-- Signup Form (Initially Hidden) -->
                        <form id="emailSignupForm" style="display: none;">
                            <h2 class="card-title text-center text-white mb-4">CREATE ACCOUNT</h2>
                            <div class="mb-3"> 
                                <label for="signupNameInputEl" class="form-label">Full Name</label> 
                                <input type="text" class="form-control" id="signupNameInputEl" placeholder="Enter your name" required> 
                            </div>

<!-- ROLE SELECTION DROPDOWN -->
<div class="mb-3">
    <label class="form-label">Select Your Combat Role</label>
    <div class="input-group">
        <span class="input-group-text bg-dark border-secondary text-secondary"><i class="bi bi-crosshair"></i></span>
        <select class="form-select bg-black text-white border-secondary" id="signupRoleInput" required>
            <option value="" selected disabled>Choose Role...</option>
            <option value="Rusher">Rusher (Assault) ‚öîÔ∏è</option>
            <option value="Sniper">Sniper üéØ</option>
            <option value="IGL">IGL (Leader) üéñÔ∏è</option>
            <option value="Support">Support üöë</option>
            <option value="All Rounder">All Rounder ‚≠ê</option>
        </select>
    </div>
</div>

                            <div class="mb-3"> 
                                <label for="signupUidInputEl" class="form-label">Free Fire UID</label> 
                                <input type="number" class="form-control" id="signupUidInputEl" placeholder="Example: 123456789" required> 
                            </div>
                            <div class="mb-3"> <label for="signupEmailInputEl" class="form-label">Email</label> <input type="email" class="form-control" id="signupEmailInputEl" placeholder="player@example.com" required> </div>
                            <div class="mb-3"> <label for="signupPasswordInputEl" class="form-label">Password</label> <input type="password" class="form-control" id="signupPasswordInputEl" placeholder="Min 6 chars" required minlength="6"> </div>
                            <div class="mb-3"> <label for="signupConfirmPasswordInputEl" class="form-label">Confirm Password</label> <input type="password" class="form-control" id="signupConfirmPasswordInputEl" placeholder="Confirm Password" required> </div>
                            <div class="mb-4"> <label for="signupReferralCodeInputEl" class="form-label">Referral Code (Optional)</label> <input type="text" class="form-control" id="signupReferralCodeInputEl" placeholder="Ex: WIN100"> </div>
                            <div id="signupStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-3 mb-3">
                                <button type="button" class="btn btn-custom-accent" id="signupEmailBtnEl">REGISTER NOW</button>
                                <button type="button" class="btn btn-custom-secondary" id="showLoginToggleBtnEl">BACK TO LOGIN</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Home Section -->
        <section id="home-section" class="section">
            <div class="swiper-container" id="promotionSliderEl" style="height: 180px;">
                <div class="swiper-wrapper placeholder-glow">
                    <div class="swiper-slide"><span class="placeholder w-100 h-100 d-block"></span></div>
                </div>
                <div class="swiper-pagination"></div>
            </div>

           <!-- ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® gamesListEl ‡¶è‡¶∞ ‡¶ú‡¶æ‡ßü‡¶æ‡¶ó‡¶æ‡ßü ‡¶è‡¶ü‡¶ø ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡ßá‡¶∏ ‡¶ï‡¶∞‡ßÅ‡¶® -->
<h3 class="section-title"><i class="bi bi-controller text-primary"></i> Select Game</h3>
<div id="gamesListEl" class="games-scroll-container">
    <!-- ‡¶ú‡¶æ‡¶≠‡¶æ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶è‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá -->
</div>

            <h3 class="section-title"><i class="bi bi-fire text-danger"></i> My Matches</h3>
            <div id="myContestsListEl" class="placeholder-glow">
                <div class="tournament-card placeholder-glow mb-3">
                    <div style="padding: 20px;">
                        <span class="placeholder col-6" style="height: 20px;"></span>
                        <span class="placeholder col-12 mt-3" style="height: 40px;"></span>
                    </div>
                </div>
                <p id="noContestsMessageEl" class="text-muted text-center py-4" style="display: none;">You haven't joined any contests yet.</p>
            </div>
        </section>

        <!-- Tournaments Section -->
        <section id="tournaments-section" class="section">
            <div class="tournament-tabs">
                <button class="tab-item active" data-status="upcoming"><i class="bi bi-calendar-event me-1"></i> Upcoming</button>
                <button class="tab-item" data-status="ongoing"><i class="bi bi-play-circle me-1"></i> Live</button>
                <button class="tab-item" data-status="completed"><i class="bi bi-trophy me-1"></i> Results</button>
            </div>
            <div id="tournamentsListContainerEl" class="placeholder-glow">
                <div class="tournament-card placeholder-glow mb-3">
                    <div style="padding: 20px;">
                        <span class="placeholder col-4" style="height: 15px;"></span>
                        <span class="placeholder col-10 mt-3" style="height: 25px;"></span>
                        <span class="placeholder col-12 mt-3" style="height: 50px;"></span>
                    </div>
                </div>
            </div>
            <p id="noTournamentsMessageEl" class="text-muted text-center mt-5" style="display: none;">No tournaments available right now.</p>
        </section>

        <!-- Wallet Section -->
        <section id="wallet-section" class="section">
            <div class="wallet-card custom-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="m-0 text-white" style="font-size: 1.5rem;">My Wallet</h2>
                        <p class="m-0 small text-muted">Manage your funds</p>
                    </div>
                    <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center" style="width: 45px; height: 45px; border: 1px solid rgba(255,255,255,0.1);">
                        <i class="bi bi-credit-card-2-front text-white" style="font-size: 1.2rem;"></i>
                    </div>
                </div>

                <div class="balance-item placeholder-glow">
                    <span class="balance-item-label d-block mb-1">Total Balance</span>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="balance-item-value" id="walletTotalBalanceEl"><span class="placeholder col-3"></span></span>
                        <button class="btn-custom-link small" id="allTransactionsBtnEl">History <i class="bi bi-chevron-right"></i></button>
                    </div>
                </div>

                <div class="balance-item placeholder-glow">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="balance-item-label d-block mb-1">Winnings</span>
                            <span class="balance-item-value text-success" id="walletWinningCashEl" style="font-size: 1.4rem;"><span class="placeholder col-3"></span></span>
                        </div>
                        <button class="btn btn-sm btn-withdraw rounded-pill px-4 py-2" id="withdrawBtnEl">WITHDRAW</button>
                    </div>
                </div>

                <div class="balance-item border-0 p-0 placeholder-glow">
                    <span class="balance-item-label d-block mb-1">Bonus</span>
                    <span class="balance-item-value text-warning" id="walletBonusCashEl" style="font-size: 1.4rem;"><span class="placeholder col-3"></span></span>
                </div>

                <button class="btn btn-custom-primary w-100 mt-4" id="addAmountWalletBtnEl">
                    <i class="bi bi-plus-lg me-2"></i>ADD FUNDS
                </button>
            </div>

            <h3 class="section-title mt-4"><i class="bi bi-clock-history text-info"></i> Recent Activity</h3>
            <div id="recentTransactionsListEl" class="placeholder-glow">
                <!-- Transaction items populated by JS -->
                <div class="custom-card p-3 mb-2 placeholder-glow d-flex align-items-center gap-3">
                    <div class="w-100">
                        <span class="placeholder col-5 d-block mb-1"></span>
                        <span class="placeholder col-3"></span>
                    </div>
                </div>
            </div>
            <p class="text-muted text-center mt-3 small" id="noTransactionsMessageEl" style="display: none;">Loading transactions...</p>
        </section>

       <!-- Leaderboard Section -->
<section id="leaderboard-section" class="section">
    <div class="d-flex align-items-center mb-3 px-2">
        <i class="bi bi-trophy-fill text-warning me-2" style="font-size:1.5rem;"></i>
        <h3 class="m-0 text-white" style="font-family:'Rajdhani', sans-serif;">Top 50 Ranking</h3>
    </div>
    
    <!-- ‡¶è‡¶á ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ ‡¶ú‡¶æ‡ßü‡¶ó‡¶æ‡ßü ‡¶ú‡¶æ‡¶≠‡¶æ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® ‡¶¨‡¶∏‡¶æ‡¶¨‡ßá -->
    <div id="leaderboardListEl" class="pb-5"></div>
</section>

        <!-- PROFILE SECTION START -->
<section id="profile-section" class="section">
    
    <!-- GROUP 1: PROFILE INFO + STATS + FIND PLAYER (3D CARD) -->
    <div class="premium-3d-box">
        
        <!-- Header: Avatar & Name -->
        <div class="profile-top-content">
            <div class="position-relative d-inline-block mb-2">
                <img src="https://via.placeholder.com/100" id="profileAvatarEl" class="profile-avatar-3d">
                <button id="editProfileTriggerBtn" class="edit-badge-btn">
                    <i class="bi bi-pencil-fill text-white" style="font-size: 0.7rem;"></i>
                </button>
            </div>
            
            <h3 class="m-0 text-white fw-bold d-flex align-items-center justify-content-center gap-2" style="font-family: 'Rajdhani', sans-serif;">
                <span id="profileNameEl">Loading...</span>
                <span id="profileRoleBadgeEl" class="badge bg-dark border border-secondary text-secondary" style="font-size: 0.6rem;">PLAYER</span>
            </h3>
            
            <!-- Email & UID -->
            <p class="text-secondary small m-0 mt-1" id="profileEmailEl">email@example.com</p>
            <div class="mt-2" onclick="copyToClipboard('#profileUidEl')" style="cursor: pointer;">
                <span class="badge bg-dark border border-secondary text-muted fw-normal px-3 py-2 rounded-pill">
                    UID: <span id="profileUidEl" class="text-info font-monospace">...</span> <i class="bi bi-copy ms-1"></i>
                </span>
            </div>
        </div>

        <!-- Stats Row (Matches / Won / Earned) -->
        <div class="stats-3d-container">
            <div class="stat-3d-item">
                <div class="stat-3d-val text-white" id="profileTotalMatchesEl">0</div>
                <div class="stat-3d-lbl">Matches</div>
            </div>
            <div class="stat-3d-item">
                <div class="stat-3d-val text-success" id="profileWonMatchesEl">0</div>
                <div class="stat-3d-lbl">Won</div>
            </div>
            <div class="stat-3d-item">
                <div class="stat-3d-val text-warning" id="profileTotalEarningsEl">‡ß≥0</div>
                <div class="stat-3d-lbl">Earned</div>
            </div>
        </div>

        <!-- Find Player Button (Inside the same 3D Box) -->
        <div class="find-player-area">
            <button class="btn-3d-gradient" data-bs-toggle="modal" data-bs-target="#manageSquadModal">
                <i class="bi bi-search"></i> Find Teammates
            </button>
        </div>
    </div>


    <!-- GROUP 2: SETTINGS & MENU LINKS (SEPARATE 3D CARD) -->
    <div class="premium-3d-box">
        
        <!-- Notification Toggle -->
        <label class="menu-list-item" style="cursor: pointer;">
            <div class="d-flex align-items-center">
                <i class="bi bi-bell menu-icon"></i>
                <span class="ms-1 fw-medium">Notifications</span>
            </div>
            <div class="form-check form-switch m-0">
                <input class="form-check-input" type="checkbox" role="switch" id="notificationSwitchEl" checked>
            </div>
        </label>

        <!-- Match Results -->
        <button class="menu-list-item" id="profileResultsBtn">
            <div class="d-flex align-items-center">
                <i class="bi bi-trophy menu-icon text-warning"></i> <!-- Colored Icon -->
                <span class="ms-1 fw-medium">Match Results</span>
            </div>
            <i class="bi bi-chevron-right arrow-icon"></i>
        </button>

        <!-- Refer & Earn -->
        <a href="#" class="menu-list-item" data-policy="refer">
            <div class="d-flex align-items-center">
                <i class="bi bi-people menu-icon"></i>
                <span class="ms-1 fw-medium">Refer & Earn</span>
            </div>
            <i class="bi bi-chevron-right arrow-icon"></i>
        </a>

        <!-- Policies -->
        <a href="#" class="menu-list-item" data-policy="privacy">
            <div class="d-flex align-items-center">
                <i class="bi bi-shield-lock menu-icon"></i>
                <span class="ms-1 fw-medium">Privacy Policy</span>
            </div>
            <i class="bi bi-chevron-right arrow-icon"></i>
        </a>

        <a href="#" class="menu-list-item" data-policy="terms">
            <div class="d-flex align-items-center">
                <i class="bi bi-file-text menu-icon"></i>
                <span class="ms-1 fw-medium">Terms & Conditions</span>
            </div>
            <i class="bi bi-chevron-right arrow-icon"></i>
        </a>

        <a href="#" class="menu-list-item" data-policy="fairPlay">
            <div class="d-flex align-items-center">
                <i class="bi bi-award menu-icon"></i>
                <span class="ms-1 fw-medium">Fair Play</span>
            </div>
            <i class="bi bi-chevron-right arrow-icon"></i>
        </a>

        <!-- Customer Support -->
        <button type="button" class="menu-list-item" id="supportContactBtn">
            <div class="d-flex align-items-center">
                <i class="bi bi-headset menu-icon"></i>
                <span class="ms-1 fw-medium">Customer Support</span>
            </div>
            <i class="bi bi-chevron-right arrow-icon"></i>
        </button>

        <!-- Logout -->
        <button class="menu-list-item" id="logoutProfileBtnEl" style="border-bottom: none;">
            <div class="d-flex align-items-center text-danger">
                <i class="bi bi-box-arrow-right menu-icon text-danger"></i>
                <span class="ms-1 fw-bold">Logout</span>
            </div>
        </button>

    </div>

    <!-- App Version / Branding footer -->
    <div class="text-center pb-5 mb-5 opacity-25">
        <small class="text-uppercase fw-bold ls-2" style="font-size: 0.65rem; letter-spacing: 2px;">SECURED BY GAMING ZONE</small>
        <div class="small">v1.0.5</div>
    </div>

</section>
    </main>

    <!-- Modals -->
    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Profile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                   
<form id="editProfileForm">
    <!-- Image Preview & Input -->
    <div class="text-center mb-4">
        <div class="position-relative d-inline-block">
            <img src="" id="editProfilePreviewImg" class="rounded-circle border border-primary" style="width: 80px; height: 80px; object-fit: cover; box-shadow: 0 0 15px rgba(108, 93, 211, 0.3);">
            <label for="editProfileImageInput" class="position-absolute bottom-0 end-0 bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 28px; height: 28px; cursor: pointer; border: 2px solid #fff;">
                <i class="bi bi-camera-fill" style="font-size: 0.8rem;"></i>
            </label>
        </div>
        <input type="file" id="editProfileImageInput" accept="image/*" style="display: none;">
        <input type="hidden" id="editProfileUploadedUrl">
        <div id="uploadStatusText" class="small text-warning mt-2" style="display: none;">Uploading image... please wait.</div>
    </div>

    <!-- Existing Inputs -->
    <div class="mb-3">
        <label class="form-label text-white">Full Name</label>
        <input type="text" class="form-control" id="editProfileNameInput" required>
    </div>
    <div class="mb-3">
        <label class="form-label text-white">Gaming UID</label>
        <input type="number" class="form-control" id="editProfileUidInput" required>
    </div>


<div class="mb-3">
    <label class="form-label text-white">Combat Role</label>
    <select class="form-select bg-dark text-white border-secondary" id="editProfileRoleInput">
        <option value="Assault">Assault (Rusher) ‚öîÔ∏è</option>
        <option value="Sniper">Sniper üéØ</option>
        <option value="IGL">IGL (Leader) üéñÔ∏è</option>
        <option value="Support">Support üöë</option>
        <option value="All Rounder">All Rounder ‚≠ê</option>
    </select>
</div>
<div class="mb-3 p-3 rounded border border-secondary" style="background: rgba(0, 255, 127, 0.05);">
    <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" role="switch" id="lookingForTeamInput">
        <label class="form-check-label text-white" for="lookingForTeamInput">
            I am looking for a Squad <span class="badge bg-success ms-2">Active</span>
        </label>
    </div>
    <small class="text-muted d-block mt-1">Enable this to appear in "Teammate Finder" searches.</small>
</div>

    <button type="submit" class="btn btn-custom-primary w-100" id="saveProfileBtn">Save Changes</button>
</form>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="policyModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="policyModalTitleEl">Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="policyModalBodyEl" style="min-height: 300px;"></div>
            </div>
        </div>
    </div>

<!-- MANAGE SQUAD MODAL (CLEAN VERSION) -->
<div class="modal fade" id="manageSquadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-glass">
            
            <!-- Header -->
            <div class="modal-header modal-header-premium border-0 pb-0">
                <div>
                    <h5 class="modal-title text-white" style="font-family: 'Rajdhani', sans-serif; font-weight: 700;">PLAYER SEARCH</h5>
                    <p class="m-0 text-muted small">Find your perfect teammates</p>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <!-- Body -->
            <div class="modal-body p-4">
                
                <!-- Teammate Finder Banner (ONLY THIS REMAINS) -->
                <div class="finder-banner" onclick="openTeammateFinder()" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid rgba(108, 93, 211, 0.3); border-radius: 12px; padding: 20px; cursor: pointer; transition: 0.3s;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <div class="rounded-circle bg-primary bg-opacity-25 p-3 text-primary">
                                <i class="bi bi-search fs-4"></i>
                            </div>
                            <div>
                                <h5 class="text-white m-0 fw-bold">Find Players</h5>
                                <span class="text-secondary small">Recruit Rushers, Snipers & IGLs</span>
                            </div>
                        </div>
                        <i class="bi bi-chevron-right text-muted fs-5"></i>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

    <!-- Add Amount Modal -->
    <div class="modal fade" id="addAmountModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-wallet2 me-2 text-primary"></i> Add Money</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4 p-3 rounded" style="background: rgba(255,165,0,0.1); border: 1px dashed var(--warning);">
                        <p class="text-white small mb-0 text-center">Send money to: <br><span class="payment-number text-warning font-monospace fs-5 fw-bold">[LOADING...]</span></p>
                    </div>
                    <form id="depositForm">
                        <div class="mb-3"><label class="form-label text-white">From Number</label><input type="text" class="form-control" id="depositFromNumberEl" placeholder="017xxxxxxxx" required></div>
                        <div class="mb-3"><label class="form-label text-white">Amount</label><input type="number" class="form-control" id="depositAmountEl" placeholder="Amount Sent" required></div>
                        <div id="depositStatusMessageEl" class="alert mt-2" style="display: none;"></div><button type="button" class="btn btn-custom-primary w-100" id="submitDepositBtnEl">Submit Request</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div class="modal fade" id="withdrawModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-cash-stack me-2 text-success"></i> Withdraw</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <p class="small text-muted mb-1">Available to withdraw</p>
                        <h3 class="text-success display-6 fw-bold" id="withdrawModalBalanceEl">‡ß≥0.00</h3>
                    </div>
                    <div class="mb-3"><label for="withdrawAmountInputEl" class="form-label">Amount (Min ‡ß≥<span id="minWithdrawAmountEl">50</span>)</label><input type="number" class="form-control" id="withdrawAmountInputEl" placeholder="0.00"></div>
                    <div class="mb-3"><label for="withdrawMethodInputEl" class="form-label">bKash/Nagad Number</label><input type="text" class="form-control" id="withdrawMethodInputEl" placeholder="017xxxxxxxx"></div>
                    <div id="withdrawStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-custom-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-custom-primary" id="submitWithdrawRequestBtnEl">Confirm Withdraw</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="matchDetailsModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="matchDetailsModalTitleEl">Match Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="matchDetailsModalBodyEl"></div>
            </div>
        </div>
    </div>

<!-- PREMIUM NOTIFICATION MODAL -->
<div class="modal fade" id="notificationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content" style="background: #09090b; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px;">
            <div class="modal-header border-bottom border-secondary border-opacity-10 p-4">
                <h5 class="modal-title text-white fw-bold"><i class="bi bi-bell-fill text-primary me-2"></i> Notifications</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3" id="notificationListContainer">
    <!-- ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ú‡¶æ‡¶≠‡¶æ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ ‡¶¨‡¶∏‡¶æ‡¶¨‡ßá -->
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TEXT RESULT MODAL (MISSING PART FIXED) -->
<div class="modal fade" id="textResultModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content" style="background:#0f0f13; border:1px solid var(--primary);">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-white">Match Results</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="textResultContainer">
                <!-- Results will actully load here via JS -->
            </div>
        </div>
    </div>
</div>

    <!-- ID/Pass Modal -->
    <div class="modal fade" id="idPasswordModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title">Room Access</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center pb-4">
                    <p class="small text-muted mb-4">Use these credentials to join the custom room.</p>
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="p-3 bg-dark border border-secondary rounded">
                                <p class="mb-1 text-muted small text-uppercase fw-bold">Room ID</p>
                                <div class="d-flex justify-content-center align-items-center gap-2">
                                    <h3 id="roomIdDisplayEl" class="text-white font-monospace m-0 placeholder-glow"><span class="placeholder col-6"></span></h3><button class="btn btn-sm btn-outline-primary copy-btn border-0" data-target="#roomIdDisplayEl"><i class="bi bi-clipboard"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="p-3 bg-dark border border-secondary rounded">
                                <p class="mb-1 text-muted small text-uppercase fw-bold">Password</p>
                                <div class="d-flex justify-content-center align-items-center gap-2">
                                    <h3 id="roomPasswordDisplayEl" class="text-white font-monospace m-0 placeholder-glow"><span class="placeholder col-6"></span></h3><button class="btn btn-sm btn-outline-primary copy-btn border-0" data-target="#roomPasswordDisplayEl"><i class="bi bi-clipboard"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-warning d-inline-flex align-items-center mt-3 py-2 small"><i class="bi bi-exclamation-triangle-fill me-2"></i> Do not share this with anyone.</div>
                </div>
            </div>
        </div>
    </div>


    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-section="home-section"><i class="bi bi-grid-fill"></i><span>LOBBY</span></button>
        <button class="nav-item" data-section="wallet-section"><i class="bi bi-wallet2"></i><span>WALLET</span></button>
        <button class="nav-item" data-section="leaderboard-section"><i class="bi bi-bar-chart-line-fill"></i><span>RANK</span></button>
        <button class="nav-item" data-section="profile-section"><i class="bi bi-person-bounding-box"></i><span>ME</span></button>
    </nav>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        // Firebase Imports
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import {
            getDatabase,
            ref,
            get,
            set,
            update,
            push,
            query,
            orderByChild,
            equalTo,
            onValue,
            runTransaction,
            off,
            limitToLast,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // ===============================================================
        // ================= !!! IMPORTANT !!! ===========================
        // Replace with your actual Firebase project configuration.
        // ===============================================================
        const firebaseConfig = {
  apiKey: "AIzaSyDphy1q4iWThpdSy9vytj3nD5YIG_2rSG4",
  authDomain: "anik-tunerment.firebaseapp.com",
  databaseURL: "https://anik-tunerment-default-rtdb.firebaseio.com",
  projectId: "anik-tunerment",
  storageBucket: "anik-tunerment.firebasestorage.app",
  messagingSenderId: "1040918448287",
  appId: "1:1040918448287:web:9daa9ebb9fa6a56a68faaa",
  measurementId: "G-1C9NSD59WF"
};
        // ===============================================================
        // ===============================================================

        // Initialize Firebase
        let app, db, auth;
        try {
            if (firebaseConfig.apiKey === "YOUR_API_KEY" || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                console.warn("Firebase config using placeholder values. Replace them with your actual project details.");
            }
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
            console.log("Firebase Initialized");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="alert alert-danger m-5 position-fixed top-0 start-0 end-0" style="z-index: 10000;">Critical Error: Could not connect. Check Firebase config & console. Error: ${error.message}</div>`;
        }

        // --- DOM Elements Cache ---
        const getElement = (id) => document.getElementById(id);
        const querySel = (selector) => document.querySelector(selector);
        const querySelAll = (selector) => document.querySelectorAll(selector);
        const elements = {
            sections: querySelAll('.section'),
            bottomNavItems: querySelAll('.bottom-nav .nav-item'),
            globalLoader: getElement('globalLoaderEl'),
            headerBackBtn: getElement('headerBackBtnEl'),
            headerTitleContainer: getElement('headerTitleContainerEl'),
            headerGameTitle: getElement('headerGameTitleEl'),
            headerWalletChip: getElement('headerWalletChipEl'),
            headerChipBalance: getElement('headerChipBalanceEl'),
            headerUserGreeting: getElement('headerUserGreetingEl'),
            appLogo: getElement('appLogoEl'),
            notificationBtn: getElement('notificationBtnEl'),
            notificationBadge: querySel('.notification-badge'),
            loginSection: getElement('login-section'),
            emailLoginForm: getElement('emailLoginForm'),
            loginEmailInput: getElement('loginEmailInputEl'),
            loginPasswordInput: getElement('loginPasswordInputEl'),
            loginEmailBtn: getElement('loginEmailBtnEl'),
            showSignupToggleBtn: getElement('showSignupToggleBtnEl'),
            loginStatusMessage: getElement('loginStatusMessageEl'),
            forgotPasswordLink: getElement('forgotPasswordLinkEl'),
            emailSignupForm: getElement('emailSignupForm'),
            signupNameInput: getElement('signupNameInputEl'),
            signupUidInput: getElement('signupUidInputEl'),
            signupEmailInput: getElement('signupEmailInputEl'),
            signupPasswordInput: getElement('signupPasswordInputEl'),
            signupConfirmPasswordInput: getElement('signupConfirmPasswordInputEl'),
            signupReferralCodeInput: getElement('signupReferralCodeInputEl'),
            signupEmailBtn: getElement('signupEmailBtnEl'),
            showLoginToggleBtn: getElement('showLoginToggleBtnEl'),
            signupStatusMessage: getElement('signupStatusMessageEl'),
            homeSection: getElement('home-section'),
            promotionSlider: getElement('promotionSliderEl'),
            gamesList: getElement('gamesListEl'),
            myContestsList: getElement('myContestsListEl'),
            noContestsMessage: getElement('noContestsMessageEl'),
            tournamentsSection: getElement('tournaments-section'),
            tournamentsListContainer: getElement('tournamentsListContainerEl'),
            noTournamentsMessage: getElement('noTournamentsMessageEl'),
            tournamentTabs: querySelAll('.tournament-tabs .tab-item'),
            walletSection: getElement('wallet-section'),
            walletTotalBalance: getElement('walletTotalBalanceEl'),
            walletWinningCash: getElement('walletWinningCashEl'),
            walletBonusCash: getElement('walletBonusCashEl'),
            allTransactionsBtn: getElement('allTransactionsBtnEl'),
            withdrawBtn: getElement('withdrawBtnEl'),
            addAmountWalletBtn: getElement('addAmountWalletBtnEl'),
            recentTransactionsList: getElement('recentTransactionsListEl'),
            noTransactionsMessage: getElement('noTransactionsMessageEl'),
            leaderboardList: getElement('leaderboardListEl'),
            profileSection: getElement('profile-section'),
            profileAvatar: getElement('profileAvatarEl'),
            profileName: getElement('profileNameEl'),
            profileEmail: getElement('profileEmailEl'),
            profileUid: getElement('profileUidEl'),

editProfileImageInput: getElement('editProfileImageInput'),
editProfilePreviewImg: getElement('editProfilePreviewImg'),
editProfileUploadedUrl: getElement('editProfileUploadedUrl'),
saveProfileBtn: getElement('saveProfileBtn'),
uploadStatusText: getElement('uploadStatusText'),
            editProfileBtn: getElement('editProfileBtnEl'),
            editProfileModalInstance: getElement('editProfileModalEl') ? new bootstrap.Modal(getElement('editProfileModalEl')) : null,
            editProfileForm: getElement('editProfileForm'),
            editProfileNameInput: getElement('editProfileNameInput'),
            editProfileUidInput: getElement('editProfileUidInput'),
            profileTotalMatches: getElement('profileTotalMatchesEl'),
            profileWonMatches: getElement('profileWonMatchesEl'),
            profileTotalEarnings: getElement('profileTotalEarningsEl'),
supportContactBtn: getElement('supportContactBtn'),
            logoutProfileBtn: getElement('logoutProfileBtnEl'),
            policyLinks: document.querySelectorAll('[data-policy]'),
            notificationSwitch: getElement('notificationSwitchEl'),
            policyModalInstance: getElement('policyModalEl') ? new bootstrap.Modal(getElement('policyModalEl')) : null,
            policyModalTitle: getElement('policyModalTitleEl'),
            policyModalBody: getElement('policyModalBodyEl'),
            addAmountModalInstance: getElement('addAmountModalEl') ? new bootstrap.Modal(getElement('addAmountModalEl')) : null,
            modalUserEmail: getElement('modalUserEmailEl'),
            withdrawModalInstance: getElement('withdrawModalEl') ? new bootstrap.Modal(getElement('withdrawModalEl')) : null,
            withdrawModalBalance: getElement('withdrawModalBalanceEl'),
            withdrawAmountInput: getElement('withdrawAmountInputEl'),
            withdrawMethodInput: getElement('withdrawMethodInputEl'),
            minWithdrawAmount: getElement('minWithdrawAmountEl'),
            withdrawStatusMessage: getElement('withdrawStatusMessageEl'),
            submitWithdrawRequestBtn: getElement('submitWithdrawRequestBtnEl'),
            matchDetailsModalInstance: getElement('matchDetailsModalEl') ? new bootstrap.Modal(getElement('matchDetailsModalEl')) : null,
            matchDetailsModalTitle: getElement('matchDetailsModalTitleEl'),
            matchDetailsModalBody: getElement('matchDetailsModalBodyEl'),
            idPasswordModalInstance: getElement('idPasswordModalEl') ? new bootstrap.Modal(getElement('idPasswordModalEl')) : null,
            roomIdDisplay: getElement('roomIdDisplayEl'),
            roomPasswordDisplay: getElement('roomPasswordDisplayEl'),
            securityWarning: getElement('securityWarning'),
            // --- ADDED: Deposit Elements ---
            depositFromNumber: getElement('depositFromNumberEl'),
            depositAmount: getElement('depositAmountEl'),
            submitDepositBtn: getElement('submitDepositBtnEl'),
            depositStatusMessage: getElement('depositStatusMessageEl'),
            //  Added results Element 
            openMatchResultsBtn: getElement('openMatchResultsBtn'),
            resultsContent: getElement('resultsContentEl'),
        };

// ‡¶∏‡¶¨ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶π‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø‡¶ï ‡¶∏‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶π‡¶¨‡ßá
document.addEventListener('click', (e) => {
    // ‡¶Ø‡¶¶‡¶ø ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¨‡¶æ ‡¶≤‡¶ø‡¶Ç‡¶ï‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá
    if(e.target.closest('button') || e.target.closest('a') || e.target.closest('.game-card')) {
        playHapticSound();
    }
});

// ‡¶π‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø‡¶ï ‡¶∏‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶™‡ßç‡¶≤‡ßá ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
function playHapticSound() {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    // ‡¶õ‡ßã‡¶ü‡ßç‡¶ü "‡¶ï‡ßç‡¶≤‡¶ø‡¶ï" ‡¶∏‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ
    oscillator.frequency.value = 1200; // 1000 Hz ‡¶´‡ßç‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶∏‡¶ø
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.02);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.02); // 20ms ‡¶™‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß
}

        // --- App State ---
        let currentUser = null;
        let userProfile = {};
        let currentSectionId = 'login-section';
        let dbListeners = {};
        let swiperInstance;
        let currentTournamentGameId = null;
        let appSettings = {};
        let validReferrerUid = null;
        let tempSignupDetails = null;

        // --- Utility Functions ---
        const showLoader = (show) => {
            if (elements.globalLoader) elements.globalLoader.style.display = show ? 'flex' : 'none';
        };

        function showStatusMessage(element, message, type = 'danger', autohide = true) {
            if (!element) return;
            element.innerHTML = message;
            element.className = `alert alert-${type} mt-3`;
            element.style.display = 'block';
            element.setAttribute('role', 'alert');
            if (autohide) {
                setTimeout(() => {
                    if (element.innerHTML === message) element.style.display = 'none';
                }, 5000);
            }
        }

        function clearStatusMessage(element) {
            if (!element) return;
            element.style.display = 'none';
            element.innerHTML = '';
            element.removeAttribute('role');
        }

        // CHANGED: Global currency formatting function for Bangladeshi Taka (‡ß≥)
        const formatCurrency = (amount) => {
            const num = Number(amount);
            if (isNaN(num)) return '‡ß≥0.00';
            return `‡ß≥${num.toFixed(2)}`;
        };

        
// --- FIXED COPY FUNCTION (Works on HTTP & HTTPS) ---
window.copyToClipboardText = function(text) {
    // ‡ßß. ‡¶Ø‡¶¶‡¶ø ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Æ‡¶°‡¶æ‡¶∞‡ßç‡¶® ‡¶π‡ßü ‡¶è‡¶¨‡¶Ç HTTPS ‡¶è ‡¶•‡¶æ‡¶ï‡ßá
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text)
            .then(() => alert('UID Copied! Paste it in Squad Manager.'))
            .catch(() => fallbackCopyText(text)); // ‡¶è‡¶∞‡¶∞ ‡¶π‡¶≤‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø
    } else {
        // ‡ß®. ‡¶Ø‡¶¶‡¶ø HTTP ‡¶π‡ßü ‡¶¨‡¶æ ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶π‡ßü
        fallbackCopyText(text);
    }
};

// ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø ‡¶Ø‡¶æ ‡¶∏‡¶¨ ‡¶ú‡¶æ‡ßü‡¶ó‡¶æ‡ßü ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá)
function fallbackCopyText(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    
    // ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶Ø‡¶æ‡¶§‡ßá ‡¶®‡ßú‡ßá ‡¶®‡¶æ ‡¶Ø‡¶æ‡ßü ‡¶§‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";

    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        const successful = document.execCommand('copy');
        if (successful) {
            alert('UID Copied! Paste it in Squad Manager.');
        } else {
            alert('Could not copy UID.');
        }
    } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
    }

    document.body.removeChild(textArea);
}

// --- Copy Function with Fallback (Fixes 'writeText' Error) ---
window.copyToClipboard = function(targetSelector) {
    // ‡ßß. ‡¶è‡¶≤‡¶ø‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
    const targetElement = document.querySelector(targetSelector);
    if (!targetElement) {
        alert('Element to copy not found.');
        return;
    }

    // ‡ß®. ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶®‡ßá‡¶ì‡ßü‡¶æ
    const textToCopy = targetElement.innerText || targetElement.textContent;

    // ‡ß©. ‡¶ö‡ßá‡¶ï‡¶ø‡¶Ç: ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá Clipboard API ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø ‡¶®‡¶æ (HTTPS)
    if (navigator.clipboard && window.isSecureContext) {
        // ‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶∞ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø
        navigator.clipboard.writeText(textToCopy)
            .then(() => {
                alert('Copied to clipboard!'); // ‡¶∏‡¶æ‡¶ï‡¶∏‡ßá‡¶∏ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú
            })
            .catch(err => {
                console.error('Failed to copy:', err);
                fallbackCopyTextToClipboard(textToCopy); // ‡¶´‡ßá‡¶á‡¶≤ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø
            });
    } else {
        // ‡ß™. ‡¶Ø‡¶¶‡¶ø HTTPS ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶è‡¶á ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá
        fallbackCopyTextToClipboard(textToCopy);
    }
};

// ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶ï‡¶™‡¶ø ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶Ø‡ßá‡¶ü‡¶æ ‡¶∏‡¶¨ ‡¶ú‡¶æ‡ßü‡¶ó‡¶æ‡ßü ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá)
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    
    // ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶è‡¶∞‡¶ø‡ßü‡¶æ‡¶ü‡¶ø ‡¶≤‡ßÅ‡¶ï‡¶ø‡ßü‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶§‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶®‡¶æ ‡¶Ø‡¶æ‡ßü
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";

    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        const successful = document.execCommand('copy');
        const msg = successful ? 'successful' : 'unsuccessful';
        if(successful) {
            alert('Copied to clipboard!');
        } else {
            alert('Unable to copy');
        }
    } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
        alert('Browser blocked copying.');
    }

    document.body.removeChild(textArea);
}


        function shareReferral(code) {
            if (!navigator.share) {
                alert('Web Share not supported. Copy the code manually.');
                return;
            }
            if (!code || code === 'N/A') {
                alert('Referral code not available.');
                return;
            }
            navigator.share({
                title: 'Join Me on Gaming Tournament!',
                text: `Join using my referral code: ${code} & get rewards! App: ${window.location.origin}`,
                url: window.location.origin
            }).catch((error) => console.log('Error sharing', error));
        }

        function generateReferralCode(length = 8) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            return result;
        }

        function getTimeRemaining(startTime) {
            if (!startTime) return 'TBA';
            const now = Date.now();
            const diff = startTime - now;
            if (diff <= 0) return 'Starting Soon';
            const days = Math.floor(diff / 86400000);
            const hours = Math.floor((diff % 86400000) / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            let o = '';
            if (days > 0) o += `${days}d `;
            if (hours > 0 || days > 0) o += `${hours}h `;
            o += `${minutes}m`;
            return o.trim() || 'Now';
        }
        const removePlaceholders = (parentElement) => {
            if (!parentElement) return;
            parentElement.classList.remove('placeholder-glow');
            parentElement.querySelectorAll('.placeholder').forEach(el => el.remove());
        };

        // --- UI Functions ---
        function showSection(sectionId) {
            if (!auth || !sectionId || !elements.sections) {
                console.error("Cannot show section", sectionId);
                return;
            }
            const targetSection = getElement(sectionId);
            if (!targetSection) {
                console.error(`Section element "${sectionId}" not found.`);
                showSection(currentUser ? 'home-section' : 'login-section');
                return;
            }
            const protectedSections = ['home-section', 'wallet-section', 'leaderboard-section', 'profile-section', 'tournaments-section'];
            const isLoggedIn = !!currentUser;
            if (protectedSections.includes(sectionId) && !isLoggedIn) {
                showSection('login-section');
                return;
            }
            if (sectionId === 'login-section' && isLoggedIn) {
                showSection('home-section');
                return;
            }
            elements.sections.forEach(sec => sec.classList.remove('active'));
            targetSection.classList.add('active');
            currentSectionId = sectionId;
            updateHeaderForSection(sectionId);
            elements.bottomNavItems.forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));
            console.log(`Loading data for section: ${sectionId}`);
            switch (sectionId) {
                case 'home-section':
                    loadHomePageData();
                    break;
                case 'wallet-section':
                    loadWalletData();
                    break;
                case 'profile-section':
                    loadProfileData();
                    break;
                case 'leaderboard-section':
    loadLeaderboardData();
    break;
                    break;
                case 'tournaments-section':
                    if (currentTournamentGameId) {
                        const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming';
                        filterTournaments(currentTournamentGameId, activeTab);
                    } else {
                        elements.tournamentsListContainer.innerHTML = '<p class="text-secondary text-center mt-4">Select a game from Home page first.</p>';
                    }
                    break;
            }
            if (sectionId === 'login-section') {
                toggleLoginForm(true);
            }
            window.scrollTo(0, 0);
        }

        function updateHeaderForSection(sectionId) {
            const showBackButton = (sectionId === 'tournaments-section');
            const defaultTitleVisible = !showBackButton;
            const gameTitleVisible = showBackButton;
            if (elements.headerBackBtn) elements.headerBackBtn.style.display = showBackButton ? 'inline-flex' : 'none';
            if (elements.headerTitleContainer) elements.headerTitleContainer.style.display = defaultTitleVisible ? 'block' : 'none';
            if (elements.headerGameTitle) elements.headerGameTitle.style.display = gameTitleVisible ? 'block' : 'none';
            if (gameTitleVisible && currentTournamentGameId && elements.headerGameTitle) {
                const gameName = appSettings?.games?.[currentTournamentGameId]?.name || `Game`;
                elements.headerGameTitle.textContent = gameName;
            } else if (defaultTitleVisible && elements.headerUserGreeting) {
                const nameToShow = userProfile?.displayName?.split(' ')[0] || (currentUser ? currentUser.email?.split('@')[0] : 'Guest') || 'Guest';
                elements.headerUserGreeting.textContent = nameToShow;
            }
        }

        function updateGlobalUI(isLoggedIn) {
            if (elements.headerWalletChip) {
                elements.headerWalletChip.style.display = isLoggedIn ? 'flex' : 'none';
                if (isLoggedIn) elements.headerWalletChip.onclick = () => showSection('wallet-section');
                else elements.headerWalletChip.onclick = null;
            }
            if (!isLoggedIn && elements.headerUserGreeting) elements.headerUserGreeting.textContent = 'Guest';
            if (!isLoggedIn && elements.headerChipBalance) elements.headerChipBalance.textContent = '0';
            elements.bottomNavItems.forEach(item => {
                const section = item.dataset.section;
                item.style.display = (section === 'home-section' || isLoggedIn) ? 'flex' : 'none';
            });
        }

        function populateUserInfo(user, profile) {
            if (!user || !profile) return;
            const displayName = profile.displayName || user.displayName || user.email?.split('@')[0] || 'User';
           

const roleBadge = document.getElementById('profileRoleBadgeEl');
if (roleBadge) {
    const userRole = profile.role || 'ROOKIE';
    roleBadge.textContent = userRole;
    
    // Reset classes
    roleBadge.className = 'badge border ms-2';
    
    // Add color based on role
    if(userRole === 'Sniper') {
        roleBadge.classList.add('bg-danger-subtle', 'text-danger', 'border-danger');
    } else if (userRole === 'Rusher') {
        roleBadge.classList.add('bg-warning-subtle', 'text-warning', 'border-warning');
    } else if (userRole === 'IGL') {
        roleBadge.classList.add('bg-info-subtle', 'text-info', 'border-info');
    } else if (userRole === 'Support') {
        roleBadge.classList.add('bg-success-subtle', 'text-success', 'border-success');
    } else {
        roleBadge.classList.add('bg-dark', 'text-secondary', 'border-secondary');
    }
}
 
            const photoURL = profile.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=6C5DD3&color=fff&bold=true&size=90`;
            const balance = (profile.balance || 0);
            const winningCash = (profile.winningCash || 0);
            const bonusCash = (profile.bonusCash || 0);
            const totalEarnings = (profile.totalEarnings || 0);
            const referralEarnings = (profile.referralEarnings || 0);
            const totalMatches = profile.totalMatches || 0;
            const wonMatches = profile.wonMatches || 0;

            if (elements.headerUserGreeting) elements.headerUserGreeting.textContent = displayName.split(' ')[0];
            if (elements.headerChipBalance) elements.headerChipBalance.textContent = Math.floor(balance);
            if (elements.walletTotalBalance) {
                elements.walletTotalBalance.textContent = formatCurrency(balance);
                removePlaceholders(elements.walletTotalBalance.closest('.placeholder-glow'));
            }
            if (elements.walletWinningCash) {
                elements.walletWinningCash.textContent = formatCurrency(winningCash);
                removePlaceholders(elements.walletWinningCash.closest('.placeholder-glow'));
            }
            if (elements.walletBonusCash) {
                elements.walletBonusCash.textContent = formatCurrency(bonusCash);
                removePlaceholders(elements.walletBonusCash.closest('.placeholder-glow'));
            }
            if (elements.withdrawModalBalance) elements.withdrawModalBalance.textContent = formatCurrency(winningCash);
            if (elements.profileAvatar) elements.profileAvatar.src = photoURL;
            if (elements.profileName) {
                elements.profileName.textContent = displayName;
                removePlaceholders(elements.profileName.closest('.placeholder-glow'));
            }
            if (elements.profileEmail) {
                elements.profileEmail.textContent = user.email || 'N/A';
                removePlaceholders(elements.profileEmail.closest('.placeholder-glow'));
            }
            if (elements.profileUid) {
                elements.profileUid.textContent = profile.gamingUid || 'Not Set';
            }
            if (elements.profileTotalMatches) {
                elements.profileTotalMatches.textContent = totalMatches;
                removePlaceholders(elements.profileTotalMatches.closest('.placeholder-glow'));
            }
            if (elements.profileWonMatches) {
                elements.profileWonMatches.textContent = wonMatches;
                removePlaceholders(elements.profileWonMatches.closest('.placeholder-glow'));
            }
            if (elements.profileTotalEarnings) {
                elements.profileTotalEarnings.textContent = formatCurrency(totalEarnings);
                removePlaceholders(elements.profileTotalEarnings.closest('.placeholder-glow'));
            }
            if (elements.earningsTotal) {
                elements.earningsTotal.textContent = formatCurrency(totalEarnings);
                removePlaceholders(elements.earningsTotal.closest('.placeholder-glow'));
            }
            if (elements.earningsReferral) {
                elements.earningsReferral.textContent = formatCurrency(referralEarnings);
                removePlaceholders(elements.earningsReferral.closest('.placeholder-glow'));
            }
            if (elements.modalUserEmail) elements.modalUserEmail.textContent = user.email || 'N/A';
        }

        function toggleLoginForm(showLogin) {
            if (!elements.emailLoginForm || !elements.emailSignupForm) return;
            clearStatusMessage(elements.loginStatusMessage);
            clearStatusMessage(elements.signupStatusMessage);
            elements.emailLoginForm.style.display = showLogin ? 'block' : 'none';
            elements.emailSignupForm.style.display = showLogin ? 'none' : 'block';
            elements.emailLoginForm.reset();
            elements.emailSignupForm.reset();
        }

        // --- Firebase Auth Functions ---
        async function signUpWithEmail() {
    if (!auth) return;
    const name = elements.signupNameInput.value.trim();
    const uid = elements.signupUidInput.value.trim();
    const em = elements.signupEmailInput.value.trim();
    const pw = elements.signupPasswordInput.value;
    const cpw = elements.signupConfirmPasswordInput.value;
    const refCode = elements.signupReferralCodeInput.value.trim();
    const roleEl = document.getElementById('signupRoleInput');
    const role = roleEl ? roleEl.value : '';

    if (!role) {
        showStatusMessage(elements.signupStatusMessage, 'Please select a Combat Role.', 'warning');
        return;
    }
    if (!name || !uid || !em || !pw || !cpw) {
        showStatusMessage(elements.signupStatusMessage, 'All fields are required.', 'warning');
        return;
    }
    if (pw !== cpw) {
        showStatusMessage(elements.signupStatusMessage, 'Passwords do not match.', 'warning');
        return;
    }
    if (pw.length < 6) {
        showStatusMessage(elements.signupStatusMessage, 'Password min 6 chars.', 'warning');
        return;
    }

    showLoader(true);
    clearStatusMessage(elements.signupStatusMessage);

    // ‡¶ü‡ßá‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡¶æ‡¶∞‡¶ø ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá, ‡¶Ø‡¶æ handleAuthStateChange ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá
    tempSignupDetails = { name, uid, role }; // role ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
    validReferrerUid = null;

    try {
        if (refCode) {
            const usersRef = ref(db, 'users');
            const q = query(usersRef, orderByChild('referralCode'), equalTo(refCode));
            const snapshot = await get(q);
            if (snapshot.exists()) {
                const referrerData = snapshot.val();
                validReferrerUid = Object.keys(referrerData)[0];
            }
        }
        await createUserWithEmailAndPassword(auth, em, pw);
        // ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø‡¶∞ ‡¶ï‡ßã‡¶° ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶®‡ßá‡¶á, handleAuthStateChange ‡¶è‡¶ü‡¶æ ‡¶ï‡¶∞‡¶¨‡ßá‡•§
    } catch (e) {
        console.error("Signup Error:", e);
        showStatusMessage(elements.signupStatusMessage, e.message, 'danger');
    } finally {
        showLoader(false);
    }
}
       
        async function loginWithEmail() {
            if (!auth) return;
            const em = elements.loginEmailInput.value.trim();
            const pw = elements.loginPasswordInput.value;
            if (!em || !pw) {
                showStatusMessage(elements.loginStatusMessage, 'Enter email & password.', 'warning');
                return;
            }
            showLoader(true);
            clearStatusMessage(elements.loginStatusMessage);
            try {
                await signInWithEmailAndPassword(auth, em, pw);
            } catch (e) {
                console.error("Login Error:", e);
                let m = `Login failed.`;
                switch (e.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential':
                        m = 'Invalid email or password.';
                        break;
                    case 'auth/invalid-email':
                        m = 'Invalid email format.';
                        break;
                    case 'auth/too-many-requests':
                        m = 'Too many attempts. Reset pass or wait.';
                        break;
                    case 'auth/network-request-failed':
                        m = 'Network error.';
                        break;
                    case 'auth/user-disabled':
                        m = 'Account disabled.';
                        break;
                    default:
                        m = `Error: ${e.message}`;
                }
                showStatusMessage(elements.loginStatusMessage, m, 'danger');
            } finally {
                showLoader(false);
            }
        }
        async function resetPassword() {
            if (!auth) return;
            const em = elements.loginEmailInput.value.trim();
            if (!em) {
                showStatusMessage(elements.loginStatusMessage, 'Enter email for password reset.', 'warning');
                return;
            }
            showLoader(true);
            clearStatusMessage(elements.loginStatusMessage);
            try {
                await sendPasswordResetEmail(auth, em);
                showStatusMessage(elements.loginStatusMessage, 'Password reset email sent! Check inbox/spam.', 'success', false);
            } catch (e) {
                console.error("Reset Pass Error:", e);
                let m = `Failed to send email.`;
                switch (e.code) {
                    case 'auth/user-not-found':
                    case 'auth/invalid-email':
                        m = 'Email not found.';
                        break;
                    case 'auth/network-request-failed':
                        m = 'Network error.';
                        break;
                    default:
                        m = `Error: ${e.message}`;
                }
                showStatusMessage(elements.loginStatusMessage, m, 'danger');
            } finally {
                showLoader(false);
            }
        }
        async function logoutUser() {
            if (!auth) return;
            try {
                showLoader(true);
                await signOut(auth);
            } catch (e) {
                console.error("Sign Out Error:", e);
                alert(`Logout failed: ${e.message}`);
                showLoader(false);
            }
        }

        // --- Auth State Change Handler ---
        async function handleAuthStateChange(user) {
            if (!auth || !db) {
                console.error("Firebase not ready in auth change");
                showLoader(false);
                return;
            }
            showLoader(true);
            detachAllDbListeners();
            currentUser = user;
            const localReferrerUid = validReferrerUid;
            validReferrerUid = null;
            if (user) {
                console.log("Auth State: Logged In", user.uid);
                const userRef = ref(db, 'users/' + user.uid);
                try {
                    const snapshot = await get(userRef);
                    if (snapshot.exists()) {
                        userProfile = snapshot.val();
                        const updates = {};
                        if (user.displayName && (!userProfile.displayName || userProfile.displayName !== user.displayName)) updates.displayName = user.displayName;
                        if (user.email && !userProfile.email) updates.email = user.email;
                        if (Object.keys(updates).length > 0) {
                            await update(userRef, updates);
                            userProfile = {
                                ...userProfile,
                                ...updates
                            };
                        }
                    } else {
                        console.log("New user, creating profile...");
                        // Use provided details or fallback
                        const finalDisplayName = tempSignupDetails?.name || user.displayName || user.email?.split('@')[0] || 'User';
                        const finalGamingUid = tempSignupDetails?.uid || null;

                        const newUserProfile = {
                            uid: user.uid,
                            displayName: finalDisplayName,
                            gamingUid: finalGamingUid, // Saving UID to Database
                            email: user.email || null,
                            photoURL: user.photoURL || null,
                            balance: appSettings.newUserBalance || 0,
                            winningCash: 0,
                            bonusCash: appSettings.newUserBonus || 0,
                            totalMatches: 0,
                            wonMatches: 0,
                            totalEarnings: 0,
                            referralEarnings: 0,
                            createdAt: Date.now(),
                            referralCode: generateReferralCode(),
                            joinedTournaments: {},
                            isAdmin: false,
                            ...(localReferrerUid && {
                                referredBy: localReferrerUid
                            })
                        };
                        
                        // Reset temp details
                        tempSignupDetails = null;
                        await set(userRef, newUserProfile);
                        userProfile = newUserProfile;
                        if (newUserProfile.bonusCash > 0) {
                            await recordTransaction(user.uid, 'signup_bonus', newUserProfile.bonusCash, `Welcome Bonus`);
                        }
                        if (localReferrerUid && appSettings.referralBonus > 0) {
                            console.log(`Awarding referral bonus of ${appSettings.referralBonus} to referrer: ${localReferrerUid}`);
                            const referrerRef = ref(db, `users/${localReferrerUid}`);
                            try {
                                const referrerUpdateResult = await runTransaction(referrerRef, (referrerData) => {
                                    if (referrerData) {
                                        referrerData.balance = (referrerData.balance || 0) + appSettings.referralBonus;
                                        referrerData.bonusCash = (referrerData.bonusCash || 0) + appSettings.referralBonus;
                                        referrerData.referralEarnings = (referrerData.referralEarnings || 0) + appSettings.referralBonus;
                                    }
                                    return referrerData;
                                });
                                if (referrerUpdateResult.committed) {
                                    await recordTransaction(localReferrerUid, 'referral_bonus', appSettings.referralBonus, `Referral Bonus from ${newUserProfile.displayName || newUserProfile.email}`);
                                    console.log("Referrer bonus awarded successfully.");
                                } else {
                                    console.error("Referrer bonus transaction aborted.");
                                }
                            } catch (referrerError) {
                                console.error("Error awarding referrer bonus:", referrerError);
                            }
                        }
                    }
                    populateUserInfo(user, userProfile);
                    setupRealtimeListeners(user.uid);
                    updateGlobalUI(true);
                    const targetSection = (currentSectionId === 'login-section' || !getElement(currentSectionId)) ? 'home-section' : currentSectionId;
                    showSection(targetSection);
                } catch (error) {
                    console.error("Profile handling error:", error);
                    alert("Error loading profile. Logging out. " + error.message);
                    try {
                        await logoutUser();
                    } catch (logoutErr) {}
                }
            } else {
                console.log("Auth State: Logged Out");
                currentUser = null;
                userProfile = {};
                updateGlobalUI(false);
                showSection('login-section');
            }
            showLoader(false);
        }

        // --- Database Interaction Functions ---
        async function loadAppSettings() {
            console.log("Loading App Settings...");
            try {
                const settingsRef = ref(db, 'settings');
                const snapshot = await get(settingsRef);
                if (snapshot.exists()) {
                    appSettings = snapshot.val() || {};
                    console.log("App Settings Loaded:", appSettings);
                    if (appSettings.logoUrl && elements.appLogo) elements.appLogo.src = appSettings.logoUrl;
                    if (appSettings.minWithdraw && elements.minWithdrawAmount) elements.minWithdrawAmount.textContent = appSettings.minWithdraw;

                    // CHANGED: Use 'paymentDetails' for bKash/Nagad number, was 'upiDetails'
                    const paymentNumberEl = document.querySelector('.payment-number');
                    if (paymentNumberEl) {
                        paymentNumberEl.textContent = appSettings.paymentDetails || '[!!! YOUR BKASH/NAGAD NUMBER HERE !!!]';
                    }

                    const contactInfoPEl = document.querySelector('.modal-body p strong#modalUserEmailEl')?.closest('p');
                    if (contactInfoPEl && appSettings.supportContact) {
                        contactInfoPEl.innerHTML = contactInfoPEl.innerHTML.replace('[!!! ADMIN CONTACT INFO HERE !!!]', appSettings.supportContact);
                    } else if (contactInfoPEl) {
                        contactInfoPEl.innerHTML = contactInfoPEl.innerHTML.replace(appSettings.supportContact || 'some_previous_value', '[!!! ADMIN CONTACT INFO HERE !!!]');
                    }
                } else {
                    console.warn("App Settings not found in database!");
                    appSettings = {};
                    const paymentNumberEl = document.querySelector('.payment-number');
                    if (paymentNumberEl) paymentNumberEl.textContent = '[!!! YOUR BKASH/NAGAD NUMBER HERE !!!]';
                    const contactInfoPEl = document.querySelector('.modal-body p strong#modalUserEmailEl')?.closest('p');
                    if (contactInfoPEl) contactInfoPEl.innerHTML = contactInfoPEl.innerHTML.replace(/.*/, '<strong><i class="bi bi-exclamation-triangle-fill text-warning"></i> IMPORTANT:</strong> After sending money, contact admin via [!!! ADMIN CONTACT INFO HERE !!!] with your registered Email (<strong id="modalUserEmailEl">...</strong>) & payment screenshot. Amount will be added manually after verification.');
                }
            } catch (e) {
                console.error("Settings load failed", e);
                appSettings = {};
            }
        }

        function loadHomePageData() {
            console.log("Loading Home Page Data...");
            if (!currentUser) {
                if (elements.promotionSlider?.querySelector('.swiper-wrapper')) elements.promotionSlider.querySelector('.swiper-wrapper').innerHTML = '';
                if (elements.gamesList) elements.gamesList.innerHTML = '';
                if (elements.myContestsList) elements.myContestsList.innerHTML = '<p class="text-secondary text-center">Login to view contests.</p>';
                return;
            }
            loadPromotions();
            loadGames();
            loadMyContests();
        }

      // --- Wallet Data Load Function ---
        function loadWalletData() {
            console.log("Loading Wallet Data...");
            if (currentUser) {
                loadRecentTransactions(); // ‡¶è‡¶ü‡¶ø ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶¨‡ßá
            }
        }

        // --- Profile Data Load Function ---
        function loadProfileData() {
            console.log("Loading Profile Data...");
            if (currentUser && userProfile) {
                populateUserInfo(currentUser, userProfile); // ‡¶è‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶á‡¶®‡¶´‡ßã ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá
            }
        }

        // --- Recent Transactions Load Function ---
        async function loadRecentTransactions() {
            if (!currentUser || !elements.recentTransactionsList) return;
            
            elements.recentTransactionsList.innerHTML = '<div class="text-center p-3 small text-muted"><div class="spinner-border spinner-border-sm text-primary me-2"></div>Loading transactions...</div>';
            
            try {
                const transRef = ref(db, 'transactions/' + currentUser.uid);
                // ‡¶∂‡ßá‡¶∑ ‡ßß‡ß¶‡¶ü‡¶ø ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶®‡¶æ
                const transQuery = query(transRef, limitToLast(10));
                const snapshot = await get(transQuery);
                
                elements.recentTransactionsList.innerHTML = '';
                if (snapshot.exists()) {
                    let list = [];
                    snapshot.forEach(child => {
                        list.push(child.val());
                    });
                    list.reverse(); // ‡¶®‡¶§‡ßÅ‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶â‡¶™‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
                    
                    list.forEach(tx => {
                        const div = document.createElement('div');
                        div.className = 'custom-card p-3 mb-2 d-flex justify-content-between align-items-center';
                        const isNegative = tx.amount < 0;
                        div.innerHTML = `
                            <div>
                                <span class="d-block text-white small fw-bold">${tx.type.replace('_', ' ').toUpperCase()}</span>
                                <span class="text-show" style="font-size: 0.7rem;">${tx.timestamp ? new Date(tx.timestamp).toLocaleString() : ''}</span>
                                <p class="m-0 small text-secondary">${tx.note || ''}</p>
                            </div>
                            <div class="text-end">
                                <span class="${isNegative ? 'text-danger' : 'text-success'} fw-bold">
                                    ${isNegative ? '-' : '+'} ‡ß≥${Math.abs(tx.amount)}
                                </span>
                            </div>
                        `;
                        elements.recentTransactionsList.appendChild(div);
                    });
                } else {
                    elements.recentTransactionsList.innerHTML = '<p class="text-center text-muted small py-3">No recent activity found.</p>';
                }
            } catch (e) {
                console.error("Trans Load Error:", e);
                elements.recentTransactionsList.innerHTML = '<p class="text-danger text-center small">Failed to load transactions.</p>';
            }
        }


// --- Transaction Recorder & Auto-Cleanup (Keep Last 20) ---
        async function recordTransaction(uid, type, amount, note = '', details = {}) {
            if (!db) return;
            console.log("Recording transaction and cleaning up...");
            const transRef = ref(db, `transactions/${uid}`);
            
            try {
                // ‡ßß. ‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
                const newTransRef = push(transRef);
                await set(newTransRef, {
                    type: type,
                    amount: amount,
                    note: note,
                    details: details,
                    timestamp: serverTimestamp()
                });

                // ‡ß®. ‡¶ï‡ßç‡¶≤‡¶ø‡¶®‡¶Ü‡¶™ ‡¶≤‡¶ú‡¶ø‡¶ï: ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡ß®‡ß¶‡¶ü‡¶ø‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø ‡¶®‡¶æ
                const snapshot = await get(transRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const keys = Object.keys(data);

                    if (keys.length > 20) {
                        // ‡¶ü‡¶æ‡¶á‡¶Æ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶™ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∏‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ (‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã‡¶ü‡¶æ ‡¶Ü‡¶ó‡ßá)
                        const sortedKeys = keys.sort((a, b) => {
                            const timeA = data[a].timestamp || 0;
                            const timeB = data[b].timestamp || 0;
                            return timeA - timeB;
                        });

                        // ‡ß®‡ß¶‡¶ü‡¶ø‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶Ø‡¶§‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ü‡¶õ‡ßá ‡¶∏‡ßá‡¶ó‡ßÅ‡¶≤‡ßã ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ
                        const overCount = sortedKeys.length - 20;
                        const keysToDelete = sortedKeys.slice(0, overCount);

                        const updates = {};
                        keysToDelete.forEach(key => {
                            updates[`transactions/${uid}/${key}`] = null;
                        });
                        
                        await update(ref(db), updates);
                        console.log(`${overCount}‡¶ü‡¶ø ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
                    }
                }
            } catch (e) {
                console.error("Critical: Transaction record failed!", e);
            }
        }

    // --- Premium Zoom & Slide Animation Logic ---
async function loadPromotions() {
    console.log("Loading Premium Promotions...");
    if (!elements.promotionSlider) return;
    
    const sliderWrapper = elements.promotionSlider.querySelector('.swiper-wrapper');
    if (!sliderWrapper) return;

    // ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç...
    sliderWrapper.innerHTML = `<div class="swiper-slide"><span class="placeholder w-100 h-100 d-block" style="border-radius:15px;"></span></div>`;

    try {
        const snapshot = await get(ref(db, 'promotions'));
        const promotions = snapshot.val() || {};
        const activePromotions = Object.values(promotions).filter(p => p.imageUrl);

        if (activePromotions.length > 0) {
            elements.promotionSlider.style.display = 'block';
            sliderWrapper.innerHTML = ''; // ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞
            
            activePromotions.forEach(promo => {
                const slide = document.createElement('div');
                slide.className = 'swiper-slide';
                slide.innerHTML = promo.link ? 
                    `<a href="${promo.link}" target="_blank"><img src="${promo.imageUrl}" alt="Promo"></a>` : 
                    `<img src="${promo.imageUrl}" alt="Promo">`;
                sliderWrapper.appendChild(slide);
            });

            // ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶°‡¶æ‡¶∞ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ
            if (swiperInstance) swiperInstance.destroy(true, true);

            // --- PREMIUM ZOOM + SLIDE CONFIGURATION ---
            swiperInstance = new Swiper(elements.promotionSlider, {
                loop: activePromotions.length > 1, 
                speed: 800, // ‡¶∏‡ßç‡¶Æ‡ßÅ‡¶• ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡¶ø‡¶∂‡¶® ‡¶∏‡ßç‡¶™‡¶ø‡¶°
                autoplay: {
                    delay: 3500,
                    disableOnInteraction: false,
                },
                effect: 'creative', // ‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶ü‡¶ø‡¶≠ ‡¶á‡¶´‡ßá‡¶ï‡ßç‡¶ü
                creativeEffect: {
                    prev: {
                        shadow: true, // ‡¶∂‡ßç‡¶Ø‡¶æ‡¶°‡ßã ‡¶Ö‡¶®
                        translate: ['-20%', 0, -1], // ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶° ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶¨‡¶æ‡¶Æ‡ßá ‡¶∏‡¶∞‡¶¨‡ßá
                        scale: 0.85, // ‡¶è‡¶¨‡¶Ç ‡¶ú‡ßÅ‡¶Æ ‡¶Ü‡¶â‡¶ü (‡¶õ‡ßã‡¶ü) ‡¶π‡¶¨‡ßá
                    },
                    next: {
                        translate: ['100%', 0, 0], // ‡¶™‡¶∞‡ßá‡¶∞ ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶° ‡¶°‡¶æ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶∏‡¶¨‡ßá
                        scale: 1, // ‡¶®‡¶∞‡¶Æ‡¶æ‡¶≤ ‡¶∏‡¶æ‡¶á‡¶ú‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
                    },
                },
                pagination: false // ‡¶°‡¶ü ‡¶¨‡¶®‡ßç‡¶ß
            });

        } else {
            elements.promotionSlider.style.display = 'none';
        }
    } catch (e) {
        console.error("Promo load failed:", e);
    }
}
                

        async function loadGames() {
    console.log("Loading Games...");
    if (!elements.gamesList) return;
    
    // ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶™‡ßç‡¶≤‡ßá‡¶∏‡¶π‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞
    elements.gamesList.innerHTML = `
        <div class="game-item"><div class="game-icon-wrapper placeholder"></div></div>
        <div class="game-item"><div class="game-icon-wrapper placeholder"></div></div>
        <div class="game-item"><div class="game-icon-wrapper placeholder"></div></div>
        <div class="game-item"><div class="game-icon-wrapper placeholder"></div></div>
    `;

    try {
        const snapshot = await get(ref(db, 'games'));
        const games = snapshot.val() || {};
        const activeGames = Object.entries(games)
            .filter(([, game]) => game.imageUrl && game.name)
            .sort(([, gameA], [, gameB]) => (gameA.order || 0) - (gameB.order || 0));

        elements.gamesList.innerHTML = ''; // ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
        
        if (activeGames.length > 0) {
            if (!appSettings.games) appSettings.games = {};
            
            activeGames.forEach(([gameId, game]) => {
                appSettings.games[gameId] = { name: game.name };
                
                const gameDiv = document.createElement('div');
                gameDiv.className = 'game-item';
                gameDiv.innerHTML = `
                    <div class="game-icon-wrapper">
                        <img src="${game.imageUrl}" alt="${game.name}">
                    </div>
                    <span>${game.name}</span>
                `;
                
                // ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü
                gameDiv.addEventListener('click', () => {
                    currentTournamentGameId = gameId;
                    loadTournamentsForGame(gameId, game.name);
                });
                
                elements.gamesList.appendChild(gameDiv);
            });
        } else {
            elements.gamesList.innerHTML = '<p class="text-secondary small">No games found.</p>';
        }
    } catch (e) {
        console.error("Games load failed:", e);
        elements.gamesList.innerHTML = '<p class="text-danger small">Error!</p>';
    }
}

        function loadTournamentsForGame(gameId, gameName) {
            console.log(`Loading tournaments for game: ${gameName} (ID: ${gameId})`);
            if (!elements.tournamentsSection) return;
            currentTournamentGameId = gameId;
            elements.tournamentTabs.forEach(t => t.classList.remove('active'));
            querySel('.tournament-tabs .tab-item[data-status="upcoming"]')?.classList.add('active');
            showSection('tournaments-section');
            filterTournaments(gameId, 'upcoming');
        }

        async function filterTournaments(gameId, status) {
            console.log(`Filtering tournaments for game ${gameId} with status ${status}`);
            if (!elements.tournamentsListContainer) return;
            elements.tournamentsListContainer.innerHTML = '';
            elements.tournamentsListContainer.classList.add('placeholder-glow');
            elements.tournamentsListContainer.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><div style="padding: 20px;"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div></div>`;
            elements.noTournamentsMessage.style.display = 'none';
            try {
                const tQuery = query(ref(db, 'tournaments'), orderByChild('gameId'), equalTo(gameId));
                const s = await get(tQuery);
                const allT = s.val() || {};
                // --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶° (Cancelled ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø) ---
const fT = Object.entries(allT).filter(([, t]) => {
    // ‡¶Ø‡¶¶‡¶ø Results ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ (completed) ‡¶π‡ßü, ‡¶§‡¶æ‡¶π‡¶≤‡ßá completed, result ‡¶è‡¶¨‡¶Ç cancelled ‡¶∏‡¶¨ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
    if (status === 'completed') {
        return t.status === 'completed' || t.status === 'result' || t.status === 'cancelled';
    }
    // ‡¶Ö‡¶®‡ßç‡¶Ø‡¶•‡¶æ‡ßü (upcoming/ongoing) ‡¶Ø‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ‡ßá ‡¶§‡ßá‡¶Æ‡¶®‡¶á ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
    return t.status === status;
}).sort(([, tA], [, tB]) => (tB.startTime || 0) - (tA.startTime || 0));
                console.log(`Found ${fT.length} tournaments matching criteria.`);
                removePlaceholders(elements.tournamentsListContainer);
                elements.tournamentsListContainer.innerHTML = '';
                if (fT.length > 0) {
                    fT.forEach(([tId, t]) => {
                        const card = createTournamentCardElement(tId, t);
                        elements.tournamentsListContainer.appendChild(card);
                    });
                } else {
                    elements.noTournamentsMessage.style.display = 'block';
                    elements.noTournamentsMessage.textContent = `No ${status} tournaments found.`;
                }
            } catch (e) {
                console.error(`Tournaments filter failed (${status}):`, e);
                removePlaceholders(elements.tournamentsListContainer);
                elements.tournamentsListContainer.innerHTML = '<p class="text-danger tc mt-4">Could not load tournaments.</p>';
                elements.noTournamentsMessage.style.display = 'none';
            }
        }

        function createTournamentCardElement(tId, t) {
    const card = document.createElement('div');
    card.className = 'tournament-card';
    card.dataset.tournamentId = tId;

    const fee = t.entryFee || 0;
    const prize = t.prizePool || 0;
    const perKill = t.perKillPrize || 0; // ‡¶™‡¶æ‡¶∞ ‡¶ï‡¶ø‡¶≤ ‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶ú
    const sTime = t.startTime ? new Date(t.startTime) : null;
    
    const dateOptions = { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
    const timeString = sTime ? sTime.toLocaleString('en-US', dateOptions) : 'TBA';
    const timerString = getTimeRemaining(t.startTime);

    const regCount = t.registeredPlayers ? Object.keys(t.registeredPlayers).length : 0;
    const maxPlayers = t.maxPlayers || 0;
    const progress = maxPlayers > 0 ? Math.min(100, (regCount / maxPlayers) * 100) : 0;

    const isJoined = currentUser && userProfile?.joinedTournaments?.[tId];

    // Status Badge
    let statusHTML = `<span class="status-live-badge">${t.status ? t.status.toUpperCase() : 'UPCOMING'}</span>`;

    // Join Button Logic
    let joinBtnHTML = '';
    if (isJoined) {
        joinBtnHTML = `<button class="btn btn-join-gradient" style="opacity: 0.9;" disabled><i class="bi bi-check-circle-fill me-1"></i> JOINED</button>`;
    } else if (t.status === 'upcoming' && regCount < maxPlayers) {
        joinBtnHTML = `<button class="btn btn-join-gradient btn-join" data-tournament-id="${tId}" data-fee="${fee}">Join Now <i class="bi bi-arrow-right ms-1"></i></button>`;
    } else {
        joinBtnHTML = `<button class="btn btn-details-outline" disabled>${regCount >= maxPlayers ? 'FULL' : 'CLOSED'}</button>`;
    }

    card.innerHTML = `
        <div class="t-header-top">
            <div class="t-header-left">
                <div class="t-game-img-wrapper">
                    <i class="${t.icon || 'bi bi-controller'}"></i>
                    <div class="t-status-dot"></div>
                </div>
                <div class="t-title-area">
                    <h3>${t.name || 'Tournament'}</h3>
                    <div class="t-meta-info">${t.tags || 'New Match'}</div>
                    <div class="t-schedule-info">
                        <span><i class="bi bi-calendar3"></i> ${timeString}</span>
                        <span class="t-timer-text"><i class="bi bi-stopwatch"></i> Starts In: ${timerString}</span>
                    </div>
                </div>
            </div>
            ${statusHTML}
        </div>

        <div class="t-stats-row">
            <div class="t-stat-box">
                <span class="t-stat-label">ENTRY FEE</span>
                <span class="t-stat-value">‡ß≥${fee}</span>
            </div>
            <div class="t-stat-box">
                <span class="t-stat-label">PRIZE POOL</span>
                <span class="t-stat-value">‡ß≥${prize}</span>
            </div>
            <div class="t-stat-box">
                <span class="t-stat-label">PER KILL</span>
                <span class="t-stat-value">‡ß≥${perKill}</span>
            </div>
        </div>

        <div class="t-progress-area">
            <div class="t-progress-label-row">
                <span>Joined Players: <b style="color:#00D2FF">${regCount}/${maxPlayers}</b></span>
                <span>${Math.round(progress)}%</span>
            </div>
            <div class="t-progress-bar-bg">
                <div class="t-progress-bar-fill" style="width: ${progress}%"></div>
            </div>
        </div>

        <div class="t-btn-group">
            <button class="btn btn-details-outline btn-details" data-tournament-id="${tId}">View Details</button>
            ${joinBtnHTML}
        </div>
        ${(isJoined && (t.status === 'ongoing' || t.showIdPass)) ? 
            `<div class="t-room-info-bar btn-idpass" data-tournament-id="${tId}"><i class="bi bi-key-fill"></i> Room ID & Password Available</div>` : ''}
    `;

    card.querySelector('.btn-details')?.addEventListener('click', handleMatchDetailsClick);
    card.querySelector('.btn-join')?.addEventListener('click', handleJoinTournamentClick);
    card.querySelector('.btn-idpass')?.addEventListener('click', handleIdPasswordClick);

    return card;
}

        async function loadMyContests() {
            console.log("Loading My Contests...");
            if (!currentUser || !elements.myContestsList) {
                if (elements.myContestsList) removePlaceholders(elements.myContestsList);
                if (elements.myContestsList) elements.myContestsList.innerHTML = '';
                if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block';
                return;
            }
            const joinedIds = Object.keys(userProfile.joinedTournaments || {});
            elements.myContestsList.classList.add('placeholder-glow');
            elements.myContestsList.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><div style="padding: 20px;"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div></div>`;
            if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'none';
            if (joinedIds.length === 0) {
                removePlaceholders(elements.myContestsList);
                elements.myContestsList.innerHTML = '';
                if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block';
                console.log("No joined contests found for user.");
                return;
            }
            console.log(`Found ${joinedIds.length} joined contest IDs.`);
            try {
                const contestPromises = joinedIds.map(id => get(ref(db, `tournaments/${id}`)));
                const snapshots = await Promise.all(contestPromises);
                removePlaceholders(elements.myContestsList);
                elements.myContestsList.innerHTML = '';
                const contestCards = [];
                snapshots.forEach((snapshot, index) => {
                    if (snapshot.exists()) {
                        const t = snapshot.val();
                        if (t.status === 'upcoming' || t.status === 'ongoing') {
                            const tId = joinedIds[index];
                            contestCards.push({
                                startTime: t.startTime || 0,
                                card: createTournamentCardElement(tId, t)
                            });
                        }
                    } else {
                        console.warn(`Joined tournament ${joinedIds[index]} not found.`);
                    }
                });
                contestCards.sort((a, b) => a.startTime - b.startTime);
                if (contestCards.length > 0) {
                    contestCards.forEach(item => elements.myContestsList.appendChild(item.card));
                } else if (elements.noContestsMessage) {
                    elements.noContestsMessage.style.display = 'block';
                    elements.noContestsMessage.textContent = "No upcoming/ongoing joined contests.";
                }
            } catch (e) {
                console.error("My contests load failed:", e);
                removePlaceholders(elements.myContestsList);
                elements.myContestsList.innerHTML = '<p class="text-danger tc">Could not load contests.</p>';
            }
        }

/// --- ‡ßß‡ß¶‡ß¶% ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶∞‡ßÄ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï ---
function listenToNotifications() {
    // ‡ßß. ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá sanitizeHTML ‡¶®‡ßá‡¶á, ‡¶§‡¶æ‡¶á ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶π‡¶ú ‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá ‡¶¶‡¶ø‡¶ö‡ßç‡¶õ‡¶ø ‡¶Ø‡¶æ‡¶§‡ßá ‡¶è‡¶∞‡¶∞ ‡¶®‡¶æ ‡¶Ü‡¶∏‡ßá
    const safeText = (str) => {
        if (!str) return "";
        return String(str).replace(/[&<>"']/g, function(m) {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
        });
    };

    const container = document.getElementById('notificationListContainer');
    const badge = document.querySelector('.notification-badge');

    if (!container) return;

    // ‡ß®. ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶™‡¶æ‡¶• ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
    const notifRef = query(ref(db, 'notifications'), orderByChild('timestamp'));

    onValue(notifRef, (snapshot) => {
        container.innerHTML = ''; // ‡¶ò‡ßã‡¶∞‡¶æ‡¶®‡ßã ‡¶¨‡¶®‡ßç‡¶ß ‡¶π‡¶¨‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá

        if (snapshot.exists()) {
            let items = [];
            snapshot.forEach(child => {
                items.push({ id: child.key, ...child.val() });
            });
            items.reverse();

            if (badge) badge.style.display = 'block';

            items.forEach(item => {
                const timeStr = item.timestamp ? new Date(item.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : '';
                
                container.innerHTML += `
                    <div class="card mb-3 border-0" style="background: rgba(255,255,255,0.05); border-radius: 16px;">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <h6 class="text-white fw-bold m-0" style="font-size: 0.95rem;">${safeText(item.title)}</h6>
                                <small class="text-muted" style="font-size: 0.65rem;">${timeStr}</small>
                            </div>
                            <p class="m-0 text-secondary small" style="line-height: 1.4; opacity: 0.8;">${safeText(item.body)}</p>
                        </div>
                    </div>`;
            });
        } else {
            if (badge) badge.style.display = 'none';
            container.innerHTML = '<div class="text-center py-5 text-muted">No notifications available.</div>';
        }
    }, (error) => {
        console.error("Firebase Error:", error);
        container.innerHTML = '<div class="text-center py-5 text-danger">Failed to load data.</div>';
    });
}

// ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ
listenToNotifications();

       // result function //
async function loadMyResults() {
    if (!currentUser || !elements.resultsContent) return;

    // ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶∏‡ßç‡¶™‡¶ø‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
    elements.resultsContent.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';

    try {
        // ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶®‡¶æ (‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤ ‡¶®‡¶æ‡¶Æ 's')
        const s = await get(ref(db, 'matchResults/' + currentUser.uid));

        // ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ
        if (s.exists()) {
            elements.resultsContent.innerHTML = ''; // ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞
            const results = s.val();

            // ‡¶≤‡ßÅ‡¶™ ‡¶ö‡¶æ‡¶≤‡¶æ‡¶®‡ßã
            Object.values(results).reverse().forEach(res => {
                const card = document.createElement('div');
                card.className = 'custom-card p-3 mb-3';
                card.innerHTML = `
                    <div class="d-flex justify-content-between mb-2">
                        <span class="small text-muted"><i class="bi bi-calendar-event me-1"></i> ${res.dateTime || 'N/A'}</span>
                        <span class="badge bg-primary-subtle text-primary" style="font-size:0.7rem;">${res.matchType || 'Classic'}</span>
                    </div>
                    <h5 class="text-white mb-1">${res.matchName || 'Tournament Match'}</h5>
                    <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top border-secondary">
                        <span class="text-secondary small"><i class="bi bi-person-fill me-1"></i> ${res.playerName || 'Player'}</span>
                        <span class="text-success fw-bold">‡ß≥${res.winningCash || '0'}</span>
                    </div>`;
                elements.resultsContent.appendChild(card);
            });

        } else {
            // ‡¶Ø‡¶¶‡¶ø ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá (else ‡¶¨‡ßç‡¶≤‡¶ï)
            elements.resultsContent.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-info-circle mb-2 d-block fs-2"></i> No results available yet.</div>';
        }

    } catch (e) {
        console.error(e);
        elements.resultsContent.innerHTML = '<p class="text-danger text-center">Error loading results.</p>';
    }
}

       // --- 3D STYLE LEADERBOARD JS ---
async function loadLeaderboardData() {
    const listEl = document.getElementById('leaderboardListEl');
    if (!listEl) return;

    listEl.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-warning"></div></div>';

    try {
        const snapshot = await get(ref(db, 'users'));

        if (snapshot.exists()) {
            let users = [];
            snapshot.forEach((child) => {
                const u = child.val();
                if (u.totalEarnings && u.totalEarnings > 0) users.push(u);
            });

            users.sort((a, b) => (b.totalEarnings || 0) - (a.totalEarnings || 0));
            const top50 = users.slice(0, 50);

            // HTML Structure
            let html = `
                <div class="leaderboard-container">
                    <div class="lb-header">
                        <span>Rank & Player</span>
                        <span>Earn</span>
                    </div>
                    <style>
.lb-header{
  display:flex;
  justify-content:space-between;
  padding:12px 16px;
  background:#0B0F1A;
  border-radius:10px;
}

.lb-header span:first-child{
  background: linear-gradient(90deg,#FFD700,#C9A24D);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  font-weight:700;
}

.lb-header span:last-child{
  background: linear-gradient(90deg,#00E5FF,#00FFC6);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  font-weight:700;
}
</style>
                    <div class="lb-list">
            `;

            if (top50.length === 0) {
                html += '<div class="text-center text-show p-5">No data available.</div>';
            } else {
                top50.forEach((u, index) => {
                    const rank = index + 1;
                    
                    // ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                    let rankClass = ''; 
                    if (rank === 1) rankClass = 'rank-1';
                    else if (rank === 2) rankClass = 'rank-2';
                    else if (rank === 3) rankClass = 'rank-3';

                    const name = u.displayName || 'Player';
                    const uid = u.gamingUid || 'HIDDEN';
                    const pic = u.photoURL || `https://ui-avatars.com/api/?name=${name}&background=121216&color=fff`;
                    const earned = u.totalEarnings || 0;
                    
                    // Animation Delay
                    const delay = index * 0.05;

                    html += `
                        <div class="lb-card ${rankClass}" style="animation-delay: ${delay}s">
                            
                            <!-- 1. Rank Number (3D Effect) -->
                            <div class="lb-rank">#${rank}</div>
                            
                            <!-- 2. Avatar -->
                            <img src="${pic}" class="lb-img">
                            
                            <!-- 3. Player Info -->
                            <div class="lb-info">
                                <span class="lb-name">${name}</span>
                                <span class="lb-uid">UID: ${uid}</span>
                            </div>
                            
                            <!-- 4. Money -->
                            <div class="lb-earn">
                                <span class="lb-amount">‡ß≥${earned}</span>
                            </div>
                        </div>
                    `;
                });
            }

            html += `</div></div>`; 
            listEl.innerHTML = html;

        } else {
            listEl.innerHTML = '<p class="text-center text-show  py-5">No players found.</p>';
        }
    } catch (e) {
        console.error(e);
        listEl.innerHTML = '<p class="text-center text-danger py-4">Data Error</p>';
    }
}


        
        
        // --- ADDED: Deposit Submit Handler ---
        async function submitDepositRequest() {
            if (!currentUser) return;
            const fromNum = elements.depositFromNumber.value.trim();
            const amount = parseFloat(elements.depositAmount.value);

            if (!fromNum || !amount || amount <= 0) {
                showStatusMessage(elements.depositStatusMessage, "Please enter valid number and amount.", "warning");
                return;
            }

            elements.submitDepositBtn.disabled = true;
            elements.submitDepositBtn.innerHTML = "Submitting...";

            const requestData = {
                uid: currentUser.uid,
                name: userProfile.displayName || currentUser.email || "User",
                fromNumber: fromNum,
                amount: amount,
                status: "pending",
                createdAt: serverTimestamp()
            };

            try {
                await push(ref(db, 'addMoneyRequest'), requestData);
                showStatusMessage(elements.depositStatusMessage, "Request submitted! Admin will verify.", "success");
                elements.depositFromNumber.value = '';
                elements.depositAmount.value = '';
                setTimeout(() => {
                    if (elements.addAmountModalInstance) elements.addAmountModalInstance.hide();
                    elements.submitDepositBtn.disabled = false;
                    elements.submitDepositBtn.innerHTML = "Submit Request";
                    clearStatusMessage(elements.depositStatusMessage);
                }, 2000);
            } catch (error) {
                console.error(error);
                showStatusMessage(elements.depositStatusMessage, "Error submitting request.", "danger");
                elements.submitDepositBtn.disabled = false;
                elements.submitDepositBtn.innerHTML = "Submit Request";
            }
        }

        // --- Modal Handlers ---
        function handleWithdrawClick() {
            if (!currentUser || !elements.withdrawModalInstance) return;
            
            // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ Winning Cash ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
            const wc = userProfile.winningCash || 0; 
            const minW = appSettings?.minWithdraw || 50;
            
            // ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤‡ßá‡¶∞ ‡¶≠‡ßá‡¶§‡¶∞‡ßá ‡¶â‡¶á‡¶®‡¶ø‡¶Ç ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            if (elements.minWithdrawAmount) elements.minWithdrawAmount.textContent = minW;
            if (elements.withdrawModalBalance) {
                elements.withdrawModalBalance.textContent = formatCurrency(wc);
                elements.withdrawModalBalance.classList.add('text-success'); // ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶ó‡ßç‡¶∞‡¶ø‡¶® ‡¶ï‡¶∞‡¶æ
            }
            
            elements.withdrawAmountInput.value = '';
            elements.withdrawMethodInput.value = '';
            clearStatusMessage(elements.withdrawStatusMessage);
            
            elements.withdrawModalInstance.show();
            triggerHaptic('light'); // ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï‡ßá ‡¶≠‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∂‡¶®
        }

        async function submitWithdrawRequestHandler() {
            if (!currentUser || !elements.withdrawModalInstance) return;
            
            const amt = parseFloat(elements.withdrawAmountInput.value);
            const mtd = elements.withdrawMethodInput.value.trim();
            const wc = userProfile.winningCash || 0;
            const minW = appSettings?.minWithdraw || 50;

            if (isNaN(amt) || amt < minW) {
                showToast(`Minimum withdraw is ‡ß≥${minW}`, 'error');
                return;
            }
            if (amt > wc) {
                showToast("Insufficient Winnings balance!", 'error');
                return;
            }
            if (!mtd) {
                showToast("Enter bKash/Nagad number.", 'error');
                return;
            }

            elements.submitWithdrawRequestBtn.disabled = true;
            elements.submitWithdrawRequestBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';

            try {
                const uRef = ref(db, `users/${currentUser.uid}`);
                
                // ‡¶è‡¶ï‡¶∂‡¶®: ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ï‡¶æ‡¶ü‡¶æ‡¶®‡ßã (Winning ‡¶è‡¶¨‡¶Ç Total Balance ‡¶â‡¶≠‡ßü ‡¶•‡ßá‡¶ï‡ßá)
                const txResult = await runTransaction(uRef, (prof) => {
                    if (prof) {
                        const currentWC = prof.winningCash || 0;
                        const currentTotal = prof.balance || 0;
                        
                        if (currentWC >= amt) {
                            prof.winningCash = currentWC - amt;
                            prof.balance = currentTotal - amt; // ‡¶ü‡ßã‡¶ü‡¶æ‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá‡¶ì ‡¶ï‡¶Æ‡¶¨‡ßá
                            return prof;
                        }
                    }
                });

                if (!txResult.committed) throw new Error("Transaction failed.");

                // ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
                const newReq = {
                    uid: currentUser.uid,
                    userName: userProfile.displayName || currentUser.email,
                    amount: amt,
                    method: mtd,
                    status: 'Pending',
                    timestamp: serverTimestamp()
                };
                
                const newWithdrawRef = await push(ref(db, 'withdrawals'), newReq);

                // ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø‡¶§‡ßá ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏‡¶∏‡¶π ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡¶æ
                await recordTransaction(currentUser.uid, 'withdraw_request', -amt, `Withdraw to ${mtd}`, { 
                    status: 'Pending',
                    requestId: newWithdrawRef.key 
                });

                showToast("Withdrawal request sent!", "success");
                elements.withdrawModalInstance.hide();

            } catch (e) {
                console.error(e);
                showToast("Error submitting request.", "error");
            } finally {
                elements.submitWithdrawRequestBtn.disabled = false;
                elements.submitWithdrawRequestBtn.innerHTML = 'Confirm Withdraw';
            }
        }

        async function handleMatchDetailsClick(event) {
            console.log("Match Details Clicked");
            if (!elements.matchDetailsModalInstance) return;
            const tId = event.currentTarget.dataset.tournamentId;
            if (!tId) return;
            elements.matchDetailsModalTitle.textContent = 'Loading...';
            elements.matchDetailsModalBody.innerHTML = '<div class="tc p-5"><div class="spinner-border spinner-border-sm"></div></div>';
            elements.matchDetailsModalInstance.show();
            try {
                const s = await get(ref(db, `tournaments/${tId}`));
                if (s.exists()) {
                    const t = s.val();
                    const gName = appSettings.games?.[t.gameId]?.name || t.gameId || 'N/A';
                    const sTimeLoc = t.startTime ? new Date(t.startTime).toLocaleString([], {
                        dateStyle: 'medium',
                        timeStyle: 'short'
                    }) : 'TBA';
                    let pDistHTML = '';
                    if (t.prizeDistribution) {
                        let fmtDist = '';
                        if (typeof t.prizeDistribution === 'object') {
                            fmtDist = Object.entries(t.prizeDistribution).map(([rank, prize]) => `Rank ${rank}: ${formatCurrency(prize)}`).join('\n');
                        } else {
                            fmtDist = String(t.prizeDistribution).replace(/\\n/g, '\n');
                        }
                        pDistHTML = `<h5>Prize Distribution:</h5><pre style="color:var(--text-secondary);">${fmtDist}</pre>`;
                    }
                    const desc = t.description || 'Standard rules apply.';
                    const fmtDesc = desc.replace(/\n/g, '<br>');
                    elements.matchDetailsModalTitle.textContent = t.name || 'Match Details';
                    elements.matchDetailsModalBody.innerHTML = `<p><strong>Game:</strong> ${gName}</p><p><strong>Mode:</strong> ${t.mode || 'N/A'}</p><p><strong>Map:</strong> ${t.map || 'N/A'}</p><p><strong>Starts:</strong> ${sTimeLoc}</p><hr style="border-color:rgba(255,255,255,0.1);"><p><strong>Entry:</strong> ${t.entryFee > 0 ? formatCurrency(t.entryFee) : 'Free'}</p><p><strong>Prize:</strong> ${formatCurrency(t.prizePool || 0)}</p><p><strong>Per Kill:</strong> ${formatCurrency(t.perKillPrize || 0)}</p><p><strong>Max Players:</strong> ${t.maxPlayers > 0 ? t.maxPlayers : 'Unlimited'}</p><hr style="border-color:rgba(255,255,255,0.1);"><h5>Rules:</h5><div style="white-space: pre-wrap; line-height: 1.6;">${fmtDesc}</div>${pDistHTML}`;
                } else elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Details not found.</p>';
            } catch (e) {
                console.error("Details load failed:", e);
                elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Error loading details.</p>';
            }
        }

        async function handleIdPasswordClick(event) {
            if (!elements.idPasswordModalInstance) return;
            const tId = event.currentTarget.dataset.tournamentId;
            if (!tId) return;
            console.log("--- Checking ID/Pass ---");
            console.log("Tournament ID (tId):", tId);
            console.log("Current User UID:", currentUser?.uid);
            if (!currentUser || !userProfile?.joinedTournaments?.[tId]) {
                console.warn("Client-side check failed: User not logged in or tId not found.");
                alert("Join the tournament first or refresh the page.");
                return;
            }
            elements.roomIdDisplay.innerHTML = '<span class="placeholder col-6"></span>';
            elements.roomPasswordDisplay.innerHTML = '<span class="placeholder col-6"></span>';
            elements.idPasswordModalInstance.show();
            try {
                const s = await get(ref(db, `tournaments/${tId}`));
                console.log("Snapshot exists?", s.exists(), "Snapshot value:", s.val());
                removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow'));
                removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow'));
                if (s.exists()) {
                    const tournamentData = s.val();
                    if (tournamentData.showIdPass) {
                        elements.roomIdDisplay.textContent = tournamentData.roomId || 'Not updated yet';
                        elements.roomPasswordDisplay.textContent = tournamentData.roomPassword || 'Not updated yet';
                    } else {
                        elements.roomIdDisplay.textContent = 'Hidden by Admin';
                        elements.roomPasswordDisplay.textContent = 'Hidden by Admin';
                    }
                } else {
                    elements.roomIdDisplay.textContent = 'Not Found';
                    elements.roomPasswordDisplay.textContent = 'Not Found';
                }
            } catch (e) {
                console.error("ID/Pass fetch error:", e);
                removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow'));
                removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow'));
                elements.roomIdDisplay.textContent = 'Error';
                elements.roomPasswordDisplay.textContent = 'Error';
                alert("Error loading ID/Password. Check permissions or network.");
            }
        }

        async function handlePolicyClick(event) {
            console.log("Policy link clicked");
            if (!elements.policyModalInstance) {
                console.error("Policy modal instance not found");
                return;
            }
            event.preventDefault();
            const policyType = event.currentTarget.dataset.policy;
            console.log("Policy type requested:", policyType);
            if (!policyType) return;
            let title = '',
                modalBodyContent = '<div class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></div>';
            elements.policyModalBody.innerHTML = modalBodyContent;
            switch (policyType) {
                case 'privacy':
                    title = 'Privacy Policy';
                    modalBodyContent = appSettings.policyPrivacy || 'Content not available.';
                    break;
                case 'terms':
                    title = 'Terms and Conditions';
                    modalBodyContent = appSettings.policyTerms || 'Content not available.';
                    break;
                case 'refund':
                    title = 'Refund and Cancellation';
                    modalBodyContent = appSettings.policyRefund || 'Content not available.';
                    break;
                case 'fairPlay':
                    title = 'Fair Play Policy';
                    modalBodyContent = appSettings.policyFairPlay || 'Content not available.';
                    break;
                case 'refer':
                    title = 'Refer & Earn';
                    if (!currentUser) {
                        alert("Login to view referral.");
                        return;
                    }
                    const refCode = userProfile.referralCode || 'N/A';
                    const refBonus = appSettings?.referralBonus || 0;
                    const refDesc = appSettings?.referralDescription || `Get ${formatCurrency(refBonus)} when your friend joins using your code.`;
                    modalBodyContent = `<div class="text-center"><h4>Refer Friends!</h4><p class="text-secondary">Share code & earn!</p><div class="my-4 p-3" style="background: rgba(255,255,255,0.05); border-radius: 8px;"><p class="small text-muted mb-1">Your Code:</p><h3 class="text-warning referral-code" id="referralCodeDisplay">${refCode}</h3><div class="mt-3"><button class="btn btn-sm btn-custom-secondary me-2 copy-btn" data-target="#referralCodeDisplay"><i class="bi bi-clipboard"></i> Copy</button><button class="btn btn-sm btn-custom-secondary" id="shareReferralBtn"><i class="bi bi-share-fill"></i> Share</button></div></div><p class="mt-3 small text-muted">${refDesc}</p></div>`;
                    break;
                default:
                    title = 'Info';
                    console.warn("Unknown policy:", policyType);
                    modalBodyContent = '<p>Content unavailable.</p>';
            }
            elements.policyModalTitle.textContent = title;
            if (typeof modalBodyContent === 'string' && policyType !== 'refer') {
                elements.policyModalBody.innerHTML = modalBodyContent.replace(/\n/g, '<br>');
            } else {
                elements.policyModalBody.innerHTML = modalBodyContent;
            }
            console.log("Showing policy modal for:", policyType);
            elements.policyModalInstance.show();
        }

        // --- Realtime Listeners Setup ---
        function setupRealtimeListeners(uid) {
            if (!uid || !db || !currentUser) return;
            detachAllDbListeners();
            console.log("Setting up realtime listener for User Profile:", uid);
            const uRef = ref(db, `users/${uid}`);
            const listFunc = onValue(uRef, (s) => {
                if (currentUser && currentUser.uid === uid) {
                    if (s.exists()) {
                        console.log("Realtime: User Profile Update Received");
                        userProfile = s.val();
                        populateUserInfo(currentUser, userProfile);
                        if (currentSectionId === 'home-section') loadMyContests();
                        if (currentSectionId === 'wallet-section') loadRecentTransactions();
                    } else {
                        console.warn("User data deleted (realtime) for:", uid);
                        alert("Account data missing or deleted. Logging out.");
                        logoutUser();
                    }
                } else {
                    console.log("Realtime listener fired for a different user. Detaching.");
                    off(uRef, 'value', listFunc);
                }
            }, (e) => {
                console.error("Listener error (user profile):", e);
            });
            dbListeners['userProfile'] = {
                path: `users/${uid}`,
                func: listFunc
            };
        }

        function detachAllDbListeners() {
            console.log("Detaching listeners:", Object.keys(dbListeners));
            let count = 0;
            for (const k in dbListeners) {
                try {
                    const {
                        path,
                        func
                    } = dbListeners[k];
                    if (path && func) {
                        off(ref(db, path), 'value', func);
                        count++;
                    } else {
                        console.warn(`Listener object invalid for key: ${k}`);
                    }
                } catch (e) {
                    console.error(`Detach error ${k}:`, e);
                }
            }
            dbListeners = {};
            console.log(`Detached ${count} listeners.`);
        }

/* =========================================
   === PREMIUM SQUAD & JOIN SYSTEM START ===
   ========================================= */

// --- 1. SQUAD MANAGEMENT (Save/Load/Delete) ---

window.loadSavedSquads = async function() {
    if (!currentUser) return;
    const list = document.getElementById('savedSquadsList');
    list.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm text-secondary"></div></div>';
    
    try {
        const snapshot = await get(ref(db, `users/${currentUser.uid}/mySquads`));
        list.innerHTML = '';
        
        if (snapshot.exists()) {
            const squads = snapshot.val();
            Object.entries(squads).forEach(([name, data]) => {
                const pCount = data.members ? data.members.length : 0;
                list.innerHTML += `
                    <div class="d-flex justify-content-between align-items-center p-2 mb-2 rounded" style="background:rgba(255,255,255,0.05); border:1px solid #333;">
                        <div>
                            <div class="text-white fw-bold">${name}</div>
                            <div class="text-muted small" style="font-size:0.75rem;">${pCount} Members Saved</div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="deleteSquad('${name}')"><i class="bi bi-trash"></i></button>
                    </div>`;
            });
        } else {
            list.innerHTML = '<div class="text-center text-muted small p-2 border border-dashed border-secondary rounded">No squads found. Create one below!</div>';
        }
    } catch (e) { console.error(e); }
};

// --- FEATURE: Teammate Finder ---
window.openTeammateFinder = function() {
    new bootstrap.Modal(document.getElementById('finderModal')).show();
    fetchActivePlayers(); // Load initial data
};

window.fetchActivePlayers = async function() {
    const list = document.getElementById('playerResultList');
    const roleFilter = document.getElementById('filterRole').value;
    
    list.innerHTML = '<div class="text-center text-muted"><div class="spinner-border spinner-border-sm"></div> Searching...</div>';

    try {
        // Query users who are looking for a team
        const q = query(ref(db, 'users'), orderByChild('isLookingForTeam'), equalTo(true));
        const snapshot = await get(q);

        list.innerHTML = '';
        if (snapshot.exists()) {
            let count = 0;
            snapshot.forEach(child => {
                const p = child.val();
                // Filter by role manually (client side)
                if (roleFilter === 'All' || p.role === roleFilter) {
                    // Don't show myself
                    if (p.uid !== currentUser.uid) {
                        count++;
                        const badgeColor = p.role === 'Sniper' ? 'danger' : (p.role === 'IGL' ? 'warning' : 'info');
                        
                        list.innerHTML += `
                            <div class="d-flex justify-content-between align-items-center p-2 rounded border border-secondary" style="background:rgba(255,255,255,0.05);">
                                <div class="d-flex align-items-center">
                                    <img src="${p.photoURL || 'https://via.placeholder.com/40'}" class="rounded-circle me-2" style="width:40px; height:40px;">
                                    <div>
                                        <div class="text-white fw-bold" style="font-size:0.9rem;">${p.displayName}</div>
                                        <span class="badge bg-${badgeColor}" style="font-size:0.65rem;">${p.role || 'Player'}</span>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-light" onclick="copyToClipboardText('${p.gamingUid}')">
                                    <i class="bi bi-clipboard"></i> UID
                                </button>
                            </div>
                        `;
                    }
                }
            });
            if(count === 0) list.innerHTML = '<div class="text-center text-muted">No players found with this role.</div>';
        } else {
            list.innerHTML = '<div class="text-center text-muted">No active players looking for team.</div>';
        }
    } catch (e) {
        console.error(e);
        list.innerHTML = '<div class="text-danger text-center">Error fetching players.</div>';
    }
};

// Helper for Copy
window.copyToClipboardText = function(text) {
    navigator.clipboard.writeText(text).then(() => alert('UID Copied! Paste it in Squad Manager.'));
};

// --- FEATURE: Auto Fetch Name by UID ---
window.fetchNameByUid = async function(inputElement, index) {
    const uid = inputElement.value.trim();
    const nameInputs = document.querySelectorAll('.player-name-input');
    const targetNameInput = nameInputs[index];

    if (!uid) {
        targetNameInput.value = '';
        return;
    }

    targetNameInput.value = "Checking...";
    targetNameInput.style.color = "yellow";

    try {
        // Query users by gamingUid
        const q = query(ref(db, 'users'), orderByChild('gamingUid'), equalTo(uid));
        const snapshot = await get(q);

        if (snapshot.exists()) {
            // Get the first match
            const userData = Object.values(snapshot.val())[0];
            targetNameInput.value = userData.displayName; // Set Name
            targetNameInput.classList.remove('text-muted');
            targetNameInput.classList.add('text-white');
            targetNameInput.style.color = "white";
        } else {
            targetNameInput.value = "Not Found!";
            targetNameInput.style.color = "red";
        }
    } catch (e) {
        console.error(e);
        targetNameInput.value = "Error";
    }
};

window.saveNewSquad = async function() {
    if (!currentUser) return;
    const sName = document.getElementById('squadNameInput').value.trim();
    if (!sName) { alert("Please give your squad a name!"); return; }

    // Leader (Self)
    let members = [{ 
        name: userProfile.displayName || "Leader", 
        uid: userProfile.gamingUid || currentUser.uid, 
        role: userProfile.role || 'Captain', // Save my role too
        isLeader: true 
    }];

    const uids = document.querySelectorAll('.player-uid-input');
    const names = document.querySelectorAll('.player-name-input');

    let isValid = true;

    uids.forEach((inp, i) => {
        const uidVal = inp.value.trim();
        const nameVal = names[i].value.trim();

        if (uidVal) {
            if (nameVal === "Not Found!" || nameVal === "Checking..." || nameVal === "Error") {
                alert(`Player ${i+2} UID is invalid. Please check.`);
                isValid = false;
                return;
            }
            members.push({
                name: nameVal || `Player ${i+2}`,
                uid: uidVal,
                isLeader: false
            });
        }
    });

    if(!isValid) return;

    try {
        await set(ref(db, `users/${currentUser.uid}/mySquads/${sName}`), { members, createdAt: serverTimestamp() });
        alert("Squad Saved Successfully with Verified Players!");
        document.getElementById('squadNameInput').value = '';
        uids.forEach(u => u.value = '');
        names.forEach(n => n.value = '');
        loadSavedSquads();
    } catch (e) { alert("Error saving: " + e.message); }
};

window.deleteSquad = async function(name) {
    if(confirm(`Delete squad "${name}"?`)) {
        await set(ref(db, `users/${currentUser.uid}/mySquads/${name}`), null);
        loadSavedSquads();
    }
};

// --- 2. ADVANCED JOIN LOGIC (Solo/Duo/Squad) ---

let pendingJoinData = null; // To store temp data during modal selection

// ‡ß®.‡ßß: ‡¶Ü‡¶ó‡ßá‡¶∞ handleJoinTournamentClick ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡ßá‡¶∏ ‡¶ï‡¶∞‡ßÅ‡¶®
async function handleJoinTournamentClick(event) {
    if (!currentUser) { showSection('login-section'); return; }

    const btn = event.currentTarget;
    const tId = btn.dataset.tournamentId;
    const fee = parseFloat(btn.dataset.fee || 0);

    // Button loading state
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Checking...';
    btn.disabled = true;

    try {
        const snap = await get(ref(db, `tournaments/${tId}`));
        if (!snap.exists()) throw new Error("Tournament not found.");
        
        const tData = snap.val();
        
        // Check if Full
        const curr = tData.registeredPlayers ? Object.keys(tData.registeredPlayers).length : 0;
        if (tData.maxPlayers > 0 && curr >= tData.maxPlayers) throw new Error("Match is Full!");

        // Check Mode
        const mode = tData.mode || 'SOLO'; // SOLO, DUO, SQUAD

        if (mode === 'SOLO') {
            // Solo ‡¶π‡¶≤‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ì ‡¶ú‡ßü‡ßá‡¶®
            await processFinalJoin(tId, fee, [{ name: userProfile.displayName, uid: userProfile.gamingUid }], 'SOLO');
        } else {
            // Duo/Squad ‡¶π‡¶≤‡ßá ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶ì‡¶™‡ßá‡¶®
            pendingJoinData = { tId, fee, mode, tName: tData.name };
            openSmartJoinModal(mode);
        }

    } catch (e) {
        alert(e.message);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// ‡ß®.‡ß®: ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶ì‡¶™‡ßá‡¶® ‡¶è‡¶¨‡¶Ç ‡¶≤‡¶ú‡¶ø‡¶ï
async function openSmartJoinModal(mode) {
    const modal = new bootstrap.Modal(document.getElementById('teamSelectModal'));
    const container = document.getElementById('teamSelectContainer');
    const feeDisplay = document.getElementById('totalFeeDisplay');
    
    // UI Setup
    document.getElementById('teamSelectTitle').textContent = `Join ${mode} Match`;
    document.getElementById('teamSelectSubtitle').textContent = mode === 'DUO' ? 'Select 1 Partner' : 'Select 3 Partners';
    feeDisplay.textContent = formatCurrency(pendingJoinData.fee);
    
    container.innerHTML = '<div class="text-center text-muted"><div class="spinner-border spinner-border-sm"></div> Loading your squads...</div>';
    modal.show();

    // Load Squads
    const s = await get(ref(db, `users/${currentUser.uid}/mySquads`));
    container.innerHTML = '';

    if (s.exists()) {
        const squads = s.val();
        
        // 1. Squad Selector Dropdown
        const select = document.createElement('select');
        select.className = 'form-select bg-dark text-white border-secondary mb-3';
        select.innerHTML = `<option value="">-- Choose a Saved Team --</option>`;
        Object.keys(squads).forEach(name => select.innerHTML += `<option value="${name}">${name}</option>`);
        container.appendChild(select);

        // 2. Player Checkbox Container
        const playersDiv = document.createElement('div');
        container.appendChild(playersDiv);

        // Dropdown Change Event
        select.addEventListener('change', (e) => {
            const sName = e.target.value;
            playersDiv.innerHTML = '';
            if(!sName) return;

            const members = squads[sName].members;
            const required = mode === 'DUO' ? 2 : 4;
            
            // Generate Player Cards
            members.forEach((mem, idx) => {
                const isLeader = mem.isLeader || mem.uid === currentUser.uid; // Check current user
                
                // Card HTML
                const card = document.createElement('div');
                card.className = `player-select-card ${isLeader ? 'selected disabled' : ''}`;
                card.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center me-3" style="width:35px; height:35px; font-weight:bold;">
                            ${mem.name.charAt(0)}
                        </div>
                        <div>
                            <h6 class="m-0 text-white" style="font-size:0.9rem;">${mem.name} ${isLeader ? '(You)' : ''}</h6>
                            <small class="text-muted" style="font-size:0.7rem;">UID: ${mem.uid}</small>
                        </div>
                    </div>
                    <input class="form-check-input squad-checkbox" type="checkbox" value="${idx}" ${isLeader ? 'checked disabled' : ''}>
                `;
                
                // Click Effect
                if(!isLeader) {
                    card.addEventListener('click', (ev) => {
                        if(ev.target.type !== 'checkbox') {
                            const cb = card.querySelector('input');
                            cb.checked = !cb.checked;
                        }
                        const cb = card.querySelector('input');
                        if(cb.checked) card.classList.add('selected');
                        else card.classList.remove('selected');
                    });
                }
                playersDiv.appendChild(card);
            });
            
            // Store raw member data
            pendingJoinData.currentSquadMembers = members;
        });

    } else {
        container.innerHTML = `<div class="alert alert-warning small">
            <i class="bi bi-exclamation-triangle me-2"></i>No saved squads found! 
            <br><a href="#" onclick="bootstrap.Modal.getInstance(document.getElementById('teamSelectModal')).hide(); document.querySelector('[data-bs-target=\\'#manageSquadModal\\']').click();">Create a Squad first</a>
        </div>`;
    }

    // ‡ß®.‡ß©: ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®
    document.getElementById('confirmTeamJoinBtn').onclick = async () => {
        if (!pendingJoinData.currentSquadMembers) { alert("Select a squad first!"); return; }

        // Get selected indexes
        const checkboxes = document.querySelectorAll('.squad-checkbox:checked');
        const required = pendingJoinData.mode === 'DUO' ? 2 : 4;

        if (checkboxes.length !== required) {
            alert(`For ${pendingJoinData.mode}, exactly ${required} players must be selected (Including You).`);
            return;
        }

        // Prepare Final List
        const finalPlayers = [];
        checkboxes.forEach(cb => {
            finalPlayers.push(pendingJoinData.currentSquadMembers[parseInt(cb.value)]);
        });

        // Hide Modal & Process
        bootstrap.Modal.getInstance(document.getElementById('teamSelectModal')).hide();
        await processFinalJoin(pendingJoinData.tId, pendingJoinData.fee, finalPlayers, pendingJoinData.mode);
    };
}

// ‡ß®.‡ß™: ‡¶´‡¶æ‡¶á‡¶®‡¶æ‡¶≤ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
async function processFinalJoin(tId, fee, playerList, mode) {
    // Confirmation
    if(!confirm(`Confirm joining for ‡ß≥${fee}? Fee will be deducted from YOUR wallet.`)) return;

    // Show Global Loader
    if(document.getElementById('globalLoaderEl')) document.getElementById('globalLoaderEl').style.display = 'flex';

    try {
        const uRef = ref(db, `users/${currentUser.uid}`);
        
        // 1. Transaction (Payment)
        const result = await runTransaction(uRef, (profile) => {
            if (profile) {
                if ((profile.balance || 0) < fee) throw new Error("Insufficient Balance!");
                
                // Check if already joined
                if (profile.joinedTournaments && profile.joinedTournaments[tId]) throw new Error("You already joined this match!");

                profile.balance -= fee;
                profile.totalMatches = (profile.totalMatches || 0) + 1;
                if (!profile.joinedTournaments) profile.joinedTournaments = {};
                profile.joinedTournaments[tId] = true;
                return profile;
            }
        });

        // 2. Register in Tournament Node
        const regPayload = {
            joinedAt: serverTimestamp(),
            teamName: mode === 'SOLO' ? playerList[0].name : (pendingJoinData?.tName || `${playerList[0].name}'s Team`),
            leaderUid: currentUser.uid,
            playerCount: playerList.length,
            members: playerList // Save full details of all players
        };

        await update(ref(db, `tournaments/${tId}/registeredPlayers/${currentUser.uid}`), regPayload);
        
        // 3. Record Transaction
        await recordTransaction(currentUser.uid, 'tournament_join', -fee, `Joined Match: ${mode}`);

        alert("‚úÖ Successfully Joined!");
        
        // Refresh UI
        if (currentSectionId === 'tournaments-section') filterTournaments(currentTournamentGameId, 'upcoming');
        if (currentSectionId === 'home-section') loadMyContests();

    } catch (e) {
        console.error(e);
        alert("Join Failed: " + (e.message || "Unknown Error"));
    } finally {
        if(document.getElementById('globalLoaderEl')) document.getElementById('globalLoaderEl').style.display = 'none';
    }
}

/* =========================================
   === PREMIUM SQUAD & JOIN SYSTEM END ===
   ========================================= */

        // --- Event Listeners Initialization ---
        // --- NEW: Text Result Modal Function ---
function openTextResultModal() {
    // ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ ‡¶è‡¶≤‡¶ø‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ (‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ID ‡¶¶‡¶ø‡ßü‡ßá)
    const modalEl = document.getElementById('textResultModal');
    if (!modalEl) {
        console.error("Modal not found!"); 
        return;
    }
    
    const modal = new bootstrap.Modal(modalEl);
    const container = document.getElementById('textResultContainer');
    modal.show();

    // ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
    container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';

    // ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶®‡¶æ (textResults ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá)
    const q = query(ref(db, 'textResults'), orderByChild('createdAt'));

    onValue(q, (snapshot) => {
        container.innerHTML = ''; // ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞

        if (snapshot.exists()) {
            let posts = [];
            snapshot.forEach(child => posts.push({ id: child.key, ...child.val() }));
            
            // ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶∏‡¶¨‡¶æ‡¶∞ ‡¶â‡¶™‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶â‡¶≤‡ßç‡¶ü‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ
            posts.reverse(); 

            posts.forEach(post => {
                const date = post.matchDate ? new Date(post.matchDate).toLocaleString() : 'Date N/A';
                const bodyText = (post.body || '').replace(/\n/g, '<br>');

                const card = document.createElement('div');
                card.className = 'mb-3 p-3 rounded';
                card.style.background = 'rgba(255, 255, 255, 0.05)';
                card.style.border = '1px solid rgba(255, 255, 255, 0.1)';

                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2 border-bottom border-secondary pb-2">
                        <h6 class="text-warning m-0 fw-bold">${post.title}</h6>
                        <small class="text-muted" style="font-size: 0.7rem;">${date}</small>
                    </div>
                    <div class="text-white small" style="line-height: 1.6; opacity: 0.9;">
                        ${bodyText}
                    </div>
                `;
                container.appendChild(card);
            });
        } else {
            container.innerHTML = '<p class="text-muted text-center py-4">No match results published yet.</p>';
        }
    });
}



        function initializeEventListeners() {
            if (!elements) return;
            console.log("Initializing listeners...");
            elements.bottomNavItems?.forEach(item => item.addEventListener('click', (e) => {
                e.preventDefault();
                showSection(item.dataset.section);
               // Profile Result Button Listener
    document.getElementById('profileResultsBtn')?.addEventListener('click', openTextResultModal);
            }));
            elements.openMatchResultsBtn?.addEventListener('click', () => { showSection('match-results-section'); loadMyResults(); });
            elements.headerBackBtn?.addEventListener('click', () => showSection('home-section'));
            elements.tournamentTabs?.forEach(tab => tab.addEventListener('click', (e) => {
                const s = e.currentTarget.dataset.status;
                if (currentTournamentGameId && s) {
                    elements.tournamentTabs.forEach(t => t.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    filterTournaments(currentTournamentGameId, s);
                }
            }));
            elements.loginEmailBtn?.addEventListener('click', loginWithEmail);
            elements.signupEmailBtn?.addEventListener('click', signUpWithEmail);
            elements.showSignupToggleBtn?.addEventListener('click', () => toggleLoginForm(false));
            elements.showLoginToggleBtn?.addEventListener('click', () => toggleLoginForm(true));
            elements.forgotPasswordLink?.addEventListener('click', (e) => {
                e.preventDefault();
                resetPassword();
            });
// --- Customer Support Click Handler ---
            elements.supportContactBtn?.addEventListener('click', () => {
                const contact = appSettings.supportContact || 'No contact info set by admin.';
                
                // ‡¶Ø‡¶¶‡¶ø ‡¶ï‡¶®‡ßç‡¶ü‡¶æ‡¶ï‡ßç‡¶ü ‡¶á‡¶®‡¶´‡ßã ‡¶è‡¶ï‡¶ü‡¶ø ‡¶≤‡¶ø‡¶Ç‡¶ï (WhatsApp/Telegram) ‡¶π‡ßü
                if (contact.startsWith('http') || contact.startsWith('https') || contact.startsWith('wa.me')) {
                    const finalUrl = contact.startsWith('wa.me') ? `https://${contact}` : contact;
                    window.open(finalUrl, '_blank');
                } else {
                    // ‡¶Ø‡¶¶‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¨‡¶æ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶π‡ßü, ‡¶§‡¶¨‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü ‡¶¨‡¶æ ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
                    alert("Contact Support: " + contact);
                }
            });
            elements.logoutProfileBtn?.addEventListener('click', logoutUser);
            elements.policyLinks?.forEach(link => link.addEventListener('click', handlePolicyClick));
            elements.notificationSwitch?.addEventListener('change', (e) => {
                console.log("Notification toggle:", e.target.checked);
            });
            elements.withdrawBtn?.addEventListener('click', handleWithdrawClick);

             // --- REPLACE START (‡¶≤‡¶æ‡¶á‡¶® ‡ß®‡ßß‡ß≠‡ßØ ‡¶è‡¶∞ ‡¶Ü‡¶∂‡ßá‡¶™‡¶æ‡¶∂‡ßá) ---
            
            // Cloudinary Config (‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏ ‡¶¨‡¶∏‡¶æ‡¶®)
            const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dzgjcsysj/image/upload";
            const CLOUDINARY_UPLOAD_PRESET = "profile_anik"; 

         
         // --- FIX: Clean Edit Profile Listener ---
document.getElementById('editProfileTriggerBtn')?.addEventListener('click', () => {
    if (!currentUser) return;

    // 1. Set Basic Inputs
    if (elements.editProfileNameInput) elements.editProfileNameInput.value = userProfile.displayName || '';
    if (elements.editProfileUidInput) elements.editProfileUidInput.value = userProfile.gamingUid || '';

    // 2. Set Role Dropdown (Safety Check)
    const roleSelect = document.getElementById('editProfileRoleInput');
    if (roleSelect) roleSelect.value = userProfile.role || 'Assault';

    // 3. Set "Looking for Team" Status
    const statusCheck = document.getElementById('lookingForTeamInput');
    if (statusCheck) statusCheck.checked = userProfile.isLookingForTeam || false;

    // 4. Handle Image Preview
    const currentPic = userProfile.photoURL || (elements.profileAvatar ? elements.profileAvatar.src : '');
    if (elements.editProfilePreviewImg) elements.editProfilePreviewImg.src = currentPic;
    if (elements.editProfileUploadedUrl) elements.editProfileUploadedUrl.value = currentPic;

    // 5. Reset UI State
    if (elements.uploadStatusText) elements.uploadStatusText.style.display = 'none';
    if (elements.saveProfileBtn) elements.saveProfileBtn.disabled = false;

    // 6. Show Modal
    if (elements.editProfileModalInstance) elements.editProfileModalInstance.show();


                
                // ‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç UID ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                elements.editProfileNameInput.value = userProfile.displayName || '';
                elements.editProfileUidInput.value = userProfile.gamingUid || '';
                // Load Role & Status
document.getElementById('editProfileRoleInput').value = userProfile.role || 'Assault';
document.getElementById('lookingForTeamInput').checked = userProfile.isLookingForTeam || false;
               
                
                elements.uploadStatusText.style.display = 'none';
                elements.saveProfileBtn.disabled = false;
                
                elements.editProfileModalInstance.show();
            });

            // 2. Image Selection & Upload to Cloudinary
            elements.editProfileImageInput?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ (‡¶≤‡ßã‡¶ï‡¶æ‡¶≤‡¶ø)
                elements.editProfilePreviewImg.src = URL.createObjectURL(file);
                
                // ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ
                elements.uploadStatusText.style.display = 'block';
                elements.uploadStatusText.innerText = "Uploading image... please wait.";
                elements.saveProfileBtn.disabled = true; // ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ö‡¶≤‡¶æ‡¶ï‡¶æ‡¶≤‡ßÄ‡¶® ‡¶∏‡ßá‡¶≠ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶Ö‡¶´

                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                try {
                    const res = await fetch(CLOUDINARY_URL, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    
                    if (data.secure_url) {
                        elements.editProfileUploadedUrl.value = data.secure_url; // ‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
                        elements.uploadStatusText.innerText = "Image uploaded successfully!";
                        elements.uploadStatusText.classList.replace('text-warning', 'text-success');
                    } else {
                        throw new Error("Upload failed");
                    }
                } catch (err) {
                    console.error(err);
                    elements.uploadStatusText.innerText = "Image upload failed. Try again.";
                    elements.uploadStatusText.classList.replace('text-warning', 'text-danger');
                    alert("Image upload failed! Check Cloudinary settings.");
                } finally {
                    elements.saveProfileBtn.disabled = false; // ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶∂‡ßá‡¶∑, ‡¶¨‡¶æ‡¶ü‡¶® ‡¶Ö‡¶®
                }
            });

            
            // --- UPDATED: Save Profile with Role & Status ---
elements.editProfileForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const newName = elements.editProfileNameInput.value.trim();
    const newUid = elements.editProfileUidInput.value.trim();
    const newRole = document.getElementById('editProfileRoleInput').value; // New
    const isLooking = document.getElementById('lookingForTeamInput').checked; // New
    const newPhotoUrl = elements.editProfileUploadedUrl.value;

    if (!newName || !newUid) {
        alert("Name and UID cannot be empty.");
        return;
    }

    const btn = elements.saveProfileBtn;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'Saving...';
    btn.disabled = true;

    try {
        await update(ref(db, `users/${currentUser.uid}`), {
            displayName: newName,
            gamingUid: newUid,
            role: newRole, // Save Role
            isLookingForTeam: isLooking, // Save Status
            photoURL: newPhotoUrl
        });

        // Update Local Profile
        userProfile.displayName = newName;
        userProfile.gamingUid = newUid;
        userProfile.role = newRole;
        userProfile.isLookingForTeam = isLooking;
        userProfile.photoURL = newPhotoUrl;

        if (elements.profileAvatar) elements.profileAvatar.src = newPhotoUrl;
        populateUserInfo(currentUser, userProfile); // UI ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂

        alert("Profile & Role Updated Successfully!");
        elements.editProfileModalInstance.hide();
    } catch (err) {
        console.error(err);
        alert("Update failed: " + err.message);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
});
            
       
            // CHANGED: Open Deposit Modal logic
            elements.addAmountWalletBtn?.addEventListener('click', () => {
                if (currentUser && elements.addAmountModalInstance) {
                    // We no longer need to set user email in text, we show the form
                    elements.addAmountModalInstance.show();
                } else if (!currentUser) {
                    alert("Login first.");
                    showSection('login-section');
                }
            });

            // ADDED: Submit Deposit Logic
            elements.submitDepositBtn?.addEventListener('click', submitDepositRequest);

            elements.submitWithdrawRequestBtn?.addEventListener('click', submitWithdrawRequestHandler);
            // ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶™‡¶™‡¶Ü‡¶™ ‡¶Ü‡¶∏‡¶¨‡ßá
elements.notificationBtn?.addEventListener('click', () => {
    const modalEl = document.getElementById('notificationModal');
    if (modalEl) {
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        // ‡¶≤‡¶æ‡¶≤ ‡¶°‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶∏‡¶∞‡¶ø‡ßü‡ßá ‡¶´‡ßá‡¶≤‡¶æ
        const badge = document.querySelector('.notification-badge');
        if (badge) badge.style.display = 'none';
    }
});
            elements.allTransactionsBtn?.addEventListener('click', () => alert('Transaction history page coming soon!'));
            elements.viewEarningsHistoryBtn?.addEventListener('click', () => alert('Earnings history coming soon!'));
            document.body.addEventListener('click', (event) => {
                if (event.target.matches('.copy-btn') || event.target.closest('.copy-btn')) {
                    const btn = event.target.closest('.copy-btn');
                    const targetSelector = btn.dataset.target;
                    if (targetSelector) {
                        copyToClipboard(targetSelector);
                    } else {
                        console.warn("Copy button missing data-target selector.");
                    }
                }
                if (event.target.matches('#shareReferralBtn') || event.target.closest('#shareReferralBtn')) {
                    const cel = getElement('referralCodeDisplay');
                    if (cel) shareReferral(cel.textContent);
                }
            });
            console.log("Listeners initialized.");
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. Init App...");
            if (typeof initializeApp !== 'function' || !auth || !db) {
                console.error("Firebase SDK failed/not ready. Cannot proceed.");
                return;
            }
            showLoader(true);
            loadAppSettings()
                .then(() => {
                    console.log("Settings loaded, initializing listeners and auth state...");
                    initializeEventListeners();
                    updateGlobalUI(false);
                    onAuthStateChanged(auth, handleAuthStateChange);
                })
                .catch(err => {
                    console.error("CRITICAL: Initial settings load failed:", err);
                    alert("Error loading essential app settings. Please try again later.");
                    initializeEventListeners();
                    updateGlobalUI(false);
listenToNotifications();
                    onAuthStateChanged(auth, handleAuthStateChange);
                });
        });
// ‡ß© ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶∏‡ßç‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡¶æ
    setTimeout(() => {
        const splash = document.getElementById('splashScreenEl');
        if (splash) {
            splash.style.transition = "opacity 0.5s ease";
            splash.style.opacity = "0";
            setTimeout(() => splash.remove(), 500);
        }
    }, 2500);
    </script>

<!-- TEAMMATE FINDER MODAL (Correct Placement) -->
<div class="modal fade" id="finderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content" style="background:#0f0f13; border:1px solid var(--primary);">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-white">Find Teammates</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex gap-2 mb-3">
                    <select id="filterRole" class="form-select bg-dark text-white form-select-sm">
                        <option value="All">All Roles</option>
                        <option value="Sniper">Sniper</option>
                        <option value="Rusher">Rusher</option>
                        <option value="IGL">IGL</option>
                        <option value="Support">Support</option>
                    </select>
                    <button class="btn btn-primary btn-sm" onclick="fetchActivePlayers()">Search</button>
                </div>
                <div id="playerResultList" class="d-grid gap-2">
                    <!-- Results will appear here -->
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>